<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Proyectos Maestro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; height: 100vh; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .main-content { display: flex; flex: 1; overflow: hidden; border-top: 1px solid #e2e8f0; }
        .task-panel { width: 920px; flex-shrink: 0; background: white; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; z-index: 20; box-shadow: 4px 0 24px rgba(0,0,0,0.02); }
        .gantt-panel { flex: 1; overflow: hidden; background: #fff; display: flex; flex-direction: column; position: relative; }
        .header-row { height: 50px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
        .data-row { min-height: 48px; height: auto; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; font-size: 0.85rem; transition: background 0.1s; }
        .data-row:hover { background-color: #f8fafc; }
        .data-row.project-row { background-color: #f8fafc; font-weight: 600; }
        .data-row.project-row:hover { background-color: #f1f5f9; }
        .task-scroll-area { overflow-y: auto; flex: 1; }
        .gantt-scroll-area { overflow-y: auto; flex: 1; overflow-x: auto; }
        .cell { padding: 4px 8px; display: flex; align-items: center; overflow: hidden; white-space: normal; word-wrap: break-word; border-right: 1px solid transparent; line-height: 1.3; }
        .cell:hover { border-right-color: rgba(0,0,0,0.05); }
        .col-icon { width: 30px; justify-content: center; cursor: pointer; color: #94a3b8; flex-shrink: 0; align-self: stretch; }
        .col-area { width: 90px; color: #475569; font-size: 0.75rem; flex-shrink: 0; font-weight: 700; }
        .col-tipo { width: 90px; flex-shrink: 0; }
        .col-estado { width: 120px; flex-shrink: 0; }
        .col-inicio { width: 120px; font-size: 0.75rem; text-align: center; justify-content: center; flex-shrink: 0; }
        .col-nombre { flex: 1; color: #334155; position: relative; min-width: 150px; padding-left: 10px; }
        .col-gestor { width: 80px; justify-content: center; color: #475569; font-size: 0.7rem; font-weight: 600; flex-shrink: 0; text-align: center; }
        .col-prioridad { width: 50px; justify-content: center; flex-shrink: 0; }
        .col-ejecutor { width: 70px; justify-content: center; color: #64748b; font-size: 0.75rem; flex-shrink: 0; }
        .col-acciones { width: 80px; justify-content: center; gap: 4px; flex-shrink: 0; }
        .priority-indicator { font-size: 1.1rem; cursor: pointer; }
        .priority-alta { color: #f59e0b; }
        .priority-baja { color: #cbd5e1; }
        .table-input { width: 100%; background: transparent; border: 1px solid #cbd5e1; border-radius: 4px; padding: 4px; font-size: 0.75rem; color: inherit; transition: all 0.2s; text-align: center; cursor: pointer; }
        .table-input:hover { background: white; border-color: #94a3b8; }
        .table-input:focus { background: white; border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        .status-badge-select { appearance: none; -webkit-appearance: none; width: 100%; text-align: center; text-align-last: center; font-weight: 700; font-size: 0.7rem; border-radius: 20px; padding: 4px 12px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s ease; text-transform: uppercase; letter-spacing: 0.02em; }
        .status-badge-select:focus { outline: none; box-shadow: 0 0 0 2px rgba(0,0,0,0.1); }
        .sb-pendiente { background-color: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .sb-proceso { background-color: #fef3c7; color: #92400e; border-color: #fde68a; }
        .sb-terminado { background-color: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .gantt-header-month { display: flex; justify-content: center; align-items: center; border-right: 1px solid #e2e8f0; font-weight: 700; color: white; }
        .gantt-week-col { min-width: 20px; border-right: 1px dashed #e2e8f0; display: flex; justify-content: center; align-items: center; cursor: pointer; position: relative; flex-shrink: 0; height: 100%; transition: background 0.1s; }
        .gantt-week-col:hover { background-color: rgba(0,0,0,0.03); }
        .status-pill { height: 22px; width: 26px; border-radius: 4px; display: flex; justify-content: center; align-items: center; font-size: 9px; font-weight: 700; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: transform 0.1s; pointer-events: none; }
        .st-1 { background: #ef4444; } .st-2 { background: #f59e0b; } .st-3 { background: #10b981; }
        .tree-line-v { position: absolute; left: 10px; top: 0; bottom: 50%; width: 1px; background-color: #cbd5e1; }
        .tree-line-h { position: absolute; left: 10px; top: 50%; width: 12px; height: 1px; background-color: #cbd5e1; }
        .tree-connector { position: absolute; left: 6px; top: 50%; transform: translateY(-50%); width: 8px; height: 8px; border-radius: 50%; border: 1px solid #cbd5e1; background: white; z-index: 2; }
        .kpi-table { border-collapse: collapse; width: 100%; white-space: nowrap; font-size: 0.75rem; }
        .kpi-table th { background: #1e293b; color: white; font-weight: 600; padding: 8px 10px; text-align: center; border: 1px solid #334155; }
        .kpi-table td { border: 1px solid #e2e8f0; padding: 4px 8px; text-align: right; color: #334155; }
        .kpi-table input { width: 100%; background: transparent; border: none; text-align: right; outline: none; font-family: inherit; font-size: inherit; color: inherit; }
        .kpi-table input:focus { background: #f0f9ff; }
        .kpi-table td.text-left { text-align: left; }
        .kpi-table tr:nth-child(even) { background-color: #f8fafc; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(4px); z-index: 50; display: none; align-items: center; justify-content: center; }
        .modal-card { background: white; border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); width: 90%; max-width: 900px; max-height: 85vh; display: flex; flex-direction: column; overflow: hidden; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-card-lg { max-width: 1200px; width: 95%; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 60; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-left: 4px solid #3b82f6; font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 10px; animation: slideInRight 0.3s ease; max-width: 300px; }
        .toast.success { border-left-color: #10b981; } .toast.error { border-left-color: #ef4444; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .btn-priority-active { background-color: #f59e0b !important; color: white !important; border-color: #d97706 !important; }
        .kpi-sidebar-item { padding: 10px; cursor: pointer; border-radius: 6px; margin-bottom: 4px; font-size: 0.8rem; border: 1px solid transparent; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .kpi-sidebar-item:hover { background-color: #f1f5f9; }
        .kpi-sidebar-item.active { background-color: #eff6ff; border-color: #bfdbfe; color: #1d4ed8; font-weight: 600; }
        .action-btn { padding: 4px; border-radius: 4px; transition: all 0.2s; }
        .action-btn:hover { background-color: #f1f5f9; }
        .refresh-spinning { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- Header -->
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 z-30">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white text-xl shadow-lg shadow-blue-200">
                    <i class="fa-solid fa-layer-group"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-800 leading-tight">Gestor de Proyectos Maestro</h1>
                </div>
            </div>

            <div class="flex items-center gap-6">
                <div class="flex items-center gap-3" style="align-items:center;">
                    <!-- Filter Month Removed -->
                    <select id="filter-area" class="table-input" style="width:150px; font-size:0.8rem;">
                        <option value="">Todas las áreas</option>
                    </select>
                    <select id="filter-project" class="table-input" style="width:220px; font-size:0.8rem;">
                        <option value="">Buscar proyecto (todos)</option>
                    </select>
                </div>
                <div class="h-6 w-px bg-slate-200"></div>
                <!-- Timestamp de última actualización -->
                <div class="flex items-center gap-2 text-xs text-slate-500 bg-slate-100 px-3 py-1.5 rounded-lg">
                    <i class="fa-solid fa-clock text-slate-400"></i>
                    <span id="lastUpdateTime">Cargando...</span>
                </div>
                <button id="btn-refresh" onclick="refreshDataManual()" class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-50 transition" title="Refrescar datos ahora">
                    <i id="refresh-icon" class="fa-solid fa-redo"></i> Refrescar
                </button>
                <div class="h-6 w-px bg-slate-200"></div>
                <button id="btn-priority" onclick="togglePriority()" class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-50 transition" title="Mostrar solo proyectos prioritarios">
                    <i class="fa-solid fa-star"></i> Prioridad
                </button>
                <button id="btn-show-complete" onclick="toggleShowCompleted()" class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-200 text-xs font-bold text-slate-600 hover:bg-slate-50 transition" title="Mostrar proyectos terminados">Ver completo</button>
                <div class="h-6 w-px bg-slate-200"></div>
                <button onclick="toggleAll(false)" class="text-slate-500 hover:text-blue-600 transition" title="Contraer Todo"><i class="fa-solid fa-compress-alt"></i></button>
                <button onclick="toggleAll(true)" class="text-slate-500 hover:text-blue-600 transition" title="Expandir Todo"><i class="fa-solid fa-expand-alt"></i></button>
                <button id="create-project-button" class="text-white bg-blue-600 hover:bg-blue-700 px-3 py-1.5 rounded text-xs font-bold transition shadow-sm" title="Crear Nuevo Proyecto">+ Nuevo Proyecto</button>
            </div>
        </header>

        <div class="main-content">
            <div class="task-panel">
                <div class="header-row px-2">
                    <div class="col-icon"></div>
                    <div class="col-area">AREA</div>
                    <div class="col-tipo">TIPO</div>
                    <div class="col-estado">ESTADO</div>
                    <div class="col-inicio">F. INICIO</div>
                    <div class="col-nombre">PROYECTO / TAREA</div>
                    <div class="col-prioridad">PRIORIDAD</div>
                    <div class="col-gestor">GESTOR</div>
                    <div class="col-ejecutor">EJECUTOR</div>
                    <div class="col-acciones"></div>
                </div>
                <div class="task-scroll-area" id="taskListContainer"></div>
            </div>
            <div class="gantt-panel">
                <div class="flex border-b border-slate-200 bg-slate-50 sticky top-0 z-10" id="ganttMonthsHeader" style="height: 25px;"></div>
                <div class="flex border-b border-slate-200 bg-white sticky top-[25px] z-10 header-row" id="ganttWeeksHeader" style="height: 25px;"></div>
                <div class="gantt-scroll-area" id="ganttGridContainer"></div>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <div id="confirmModal" class="modal-overlay">
        <div class="modal-card" style="max-width: 400px;">
            <div class="p-6 text-center">
                <div class="w-12 h-12 rounded-full bg-red-100 text-red-600 flex items-center justify-center mx-auto mb-4 text-xl">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">¿Estás seguro?</h3>
                <p id="confirmMessage" class="text-sm text-slate-500 mb-6"></p>
                <div class="flex justify-center gap-3">
                    <button onclick="closeConfirmModal()" class="px-4 py-2 bg-slate-100 rounded text-slate-700 font-medium hover:bg-slate-200 transition">Cancelar</button>
                    <button id="confirmBtnAction" class="px-4 py-2 bg-red-600 text-white rounded font-medium hover:bg-red-700 transition shadow-lg shadow-red-200">Si, Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal KPI (Multi-KPI) -->
    <div id="kpiModal" class="modal-overlay">
        <div class="modal-card modal-card-lg" style="height: 80vh;">
            <div class="flex items-center justify-between px-6 py-4 bg-blue-900 text-white flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded bg-white/10 flex items-center justify-center"><i class="fa-solid fa-chart-line"></i></div>
                    <div>
                        <h3 class="text-sm font-bold uppercase tracking-wider">Gestión de KPIs</h3>
                        <p id="kpiModalProjectTitle" class="text-xs text-blue-200">Nombre del Proyecto</p>
                    </div>
                </div>
                <button onclick="closeKpiModal()" class="text-white/70 hover:text-white text-xl transition"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="flex flex-1 overflow-hidden">
                <div class="w-64 bg-slate-50 border-r border-slate-200 p-4 flex flex-col">
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Mis Indicadores</h4>
                    <div id="kpiListContainer" class="flex-1 overflow-y-auto mb-4"></div>
                    <button onclick="createNewKpi()" class="w-full py-2 bg-white border border-slate-300 rounded text-sm text-blue-600 font-bold hover:bg-blue-50 transition shadow-sm"><i class="fa-solid fa-plus"></i> Nuevo KPI</button>
                </div>
                <div class="flex-1 p-6 overflow-y-auto" id="kpiFormContainer"></div>
            </div>
            <div class="px-6 py-3 border-t border-slate-200 bg-white flex justify-end gap-3 flex-shrink-0">
                <button onclick="closeKpiModal()" class="px-4 py-2 text-sm font-bold text-slate-600 bg-slate-100 rounded-lg hover:bg-slate-200 transition">Cerrar</button>
                <button onclick="saveCurrentKpi()" class="px-5 py-2 text-sm font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition shadow-lg shadow-blue-200">Guardar KPI Actual</button>
            </div>
        </div>
    </div>

    <!-- Modal Crear Campo -->
    <div id="createFieldModal" class="modal-overlay" style="display:none;">
        <div class="modal-card modal-card-lg">
            <div class="flex items-center justify-between px-6 py-4 bg-blue-900 text-white">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded bg-white/10 flex items-center justify-center"><i class="fa-solid fa-plus"></i></div>
                    <div><h3 id="cf-modal-title" class="text-sm font-bold uppercase tracking-wider">Crear Nuevo</h3><p id="cf-modal-subtitle" class="text-xs text-blue-200">Nuevo requerimiento</p></div>
                </div>
                <button id="createFieldClose" class="text-white/70 hover:text-white text-xl transition"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 bg-slate-50 flex-1 overflow-auto">
                <div class="grid grid-cols-2 gap-6">
                    <label class="block"><span class="text-xs font-bold text-slate-500 uppercase mb-1 block">Área</span><select id="cf-area" class="w-full border border-slate-300 rounded p-2 text-sm bg-white outline-none"></select></label>
                    <div id="div-cf-project-select" style="display:none;">
                         <label class="block"><span class="text-xs font-bold text-slate-500 uppercase mb-1 block">Proyecto</span><input id="cf-project-readonly" class="w-full border border-slate-300 rounded p-2 text-sm bg-slate-100 text-slate-500 outline-none" readonly></label>
                    </div>
                    <div id="div-cf-project-input">
                         <label class="block"><span class="text-xs font-bold text-slate-500 uppercase mb-1 block">Nombre del Proyecto</span><input id="cf-project-input" class="w-full border border-slate-300 rounded p-2 text-sm outline-none" placeholder="Nombre del nuevo proyecto"></label>
                    </div>
                    <div id="div-cf-gestor">
                        <label class="block"><span class="text-xs font-bold text-slate-500 uppercase mb-1 block">Gestor (Proyecto)</span><input id="cf-gestor" class="w-full border border-slate-300 rounded p-2 text-sm outline-none" placeholder="Gestor del proyecto"></label>
                    </div>
                    <label class="block"><span class="text-xs font-bold text-slate-500 uppercase mb-1 block">Tipo</span><select id="cf-tipo" class="w-full border border-slate-300 rounded p-2 text-sm bg-white outline-none"></select></label>
                    <div id="div-cf-prioridad">
                        <label class="block"><span class="text-xs font-bold text-slate-500 uppercase mb-1 block">Prioridad</span><select id="cf-prioridad" class="w-full border border-slate-300 rounded p-2 text-sm bg-white outline-none"><option value="BAJA">BAJA</option><option value="ALTA">ALTA</option></select></label>
                    </div>
                    <div id="div-cf-task" class="block col-span-2">
                        <label class="block"><span class="text-xs font-bold text-slate-500 uppercase mb-1 block">Nombre de la Tarea</span><input id="cf-task" class="w-full border border-slate-300 rounded p-2 text-sm outline-none" placeholder="Nombre de la tarea"></label>
                    </div>
                    <div id="div-cf-task-readonly" class="block col-span-2" style="display:none;">
                        <label class="block"><span class="text-xs font-bold text-slate-500 uppercase mb-1 block">Nombre de la Tarea</span><input id="cf-task-readonly" class="w-full border border-slate-300 rounded p-2 text-sm bg-slate-100 text-slate-500 outline-none" readonly></label>
                    </div>
                    <label class="block"><span class="text-xs font-bold text-slate-500 uppercase mb-1 block">F. Inicio</span><input id="cf-inicio" type="date" class="w-full border border-slate-300 rounded p-2 text-sm outline-none"></label>
                    <div id="div-cf-ejecutor">
                        <label class="block"><span class="text-xs font-bold text-slate-500 uppercase mb-1 block">Ejecutor (Tarea)</span><select id="cf-ejecutor" class="w-full border border-slate-300 rounded p-2 text-sm bg-white outline-none"></select></label>
                    </div>
                </div>
            </div>
            <div class="px-6 py-3 border-t border-slate-200 bg-white flex justify-end">
                <button id="cf-cancel" class="px-4 py-2 mr-2 bg-slate-100 text-slate-600 font-medium rounded hover:bg-slate-200 transition">Cancelar</button>
                <button id="cf-save" class="px-4 py-2 bg-emerald-600 text-white font-medium rounded hover:bg-emerald-700 transition shadow-lg shadow-emerald-200">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Edit Task -->
    <div id="editTaskModal" class="modal-overlay" style="display:none;">
        <div class="modal-card modal-card-lg">
            <div class="flex items-center justify-between px-6 py-4 bg-blue-900 text-white">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded bg-white/10 flex items-center justify-center"><i class="fa-solid fa-pen-to-square"></i></div>
                    <div><h3 class="text-sm font-bold uppercase tracking-wider">Editar Tarea</h3></div>
                </div>
                <button onclick="closeEditTaskModal()" class="text-white/70 hover:text-white text-xl transition"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 bg-slate-50 flex-1 overflow-auto">
                <div class="grid grid-cols-2 gap-6">
                    <label class="block col-span-2"><span class="text-xs font-bold text-slate-500 uppercase mb-1 block">Nombre</span><input id="edit-task-name" class="w-full border border-slate-300 rounded p-2 text-sm outline-none"></label>
                    <label class="block"><span class="text-xs font-bold text-slate-500 uppercase mb-1 block">Tipo</span><select id="edit-task-tipo" class="w-full border border-slate-300 rounded p-2 text-sm bg-white outline-none"></select></label>
                    <label class="block"><span class="text-xs font-bold text-slate-500 uppercase mb-1 block">Estado</span><select id="edit-task-estado" class="w-full border border-slate-300 rounded p-2 text-sm bg-white outline-none"><option value="1">Pendiente</option><option value="2">En Proceso</option><option value="3">Terminado</option></select></label>
                    <label class="block"><span class="text-xs font-bold text-slate-500 uppercase mb-1 block">F. Inicio</span><input id="edit-task-inicio" type="date" class="w-full border border-slate-300 rounded p-2 text-sm outline-none"></label>
                    <label class="block"><span class="text-xs font-bold text-slate-500 uppercase mb-1 block">Ejecutor</span><input id="edit-task-ejecutor" class="w-full border border-slate-300 rounded p-2 text-sm outline-none"></label>
                </div>
            </div>
            <div class="px-6 py-3 border-t border-slate-200 bg-white flex justify-end">
                <button onclick="closeEditTaskModal()" class="px-4 py-2 mr-2 bg-slate-100 text-slate-600 font-medium rounded hover:bg-slate-200 transition">Cancelar</button>
                <button onclick="saveEditedTask()" class="px-4 py-2 bg-emerald-600 text-white font-medium rounded hover:bg-emerald-700 transition shadow-lg shadow-emerald-200">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        // ========= CONFIG & GLOBALS =========
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxmzcp8_6h51NAihkIE04ZA_JPBghNuCRGKik2XlGlp4uRMbVIpjXEc2u07TiIhOWB_/exec';
        const PROJECT_TYPES = ['Digital', 'Digital + IA', 'Maquina', 'Proceso'];
        const STATUS_BADGE_CLASSES = { 1: 'sb-pendiente', 2: 'sb-proceso', 3: 'sb-terminado' };
        const STATE_ICONS = { 0: '', 1: '!', 2: '►', 3: '✓' };
        const STATE_COLORS = { 1: 'bg-red-500', 2: 'bg-amber-500', 3: 'bg-emerald-500' };
        
        let projectData = [];
        let projectMap = new Map(); // Fast lookup by ID
        let currentKpiProject = null;
        let activeKpiIndex = 0;
        let SHOW_PRIORITY = true;
        let SHOW_COMPLETED = false;
        let SHOW_ALL_TASKS = true; // when true, list every task in the left panel regardless of GANTT view range
        const FILTERS = { month: 'all', area: '', project: '' };
        let currentEdit = null;
        let confirmCallback = null;
        let createMode = 'project'; 
        let targetProjectId = null;
        let renderScheduled = false; // Debounce render
        const ganttMinMaxCache = new Map(); // Cache min/max for gantt arrays
        
        // === AUTO-REFRESH CONFIGURATION ===
        let lastUpdateTime = null;
        const AUTO_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutos en milisegundos
        let autoRefreshTimerId = null;
        let isLoadingData = false;
        
        // === CACHED COLUMNS DATA (Para optimizar modal) ===
        let cachedColumns = { areas: [], ejecutores: [], tipos: PROJECT_TYPES };
        let columnsCacheLoaded = false;

        // Reflect default priority button state in UI (script runs after DOM)
        if (SHOW_PRIORITY) {
            const _btn = document.getElementById('btn-priority');
            if (_btn) _btn.classList.add('btn-priority-active');
        }

        // 12 Months Config (Master)
        const FULL_MONTHS_CONFIG = [
            { name: 'Ene', weeks: 5, color: 'bg-slate-600' }, { name: 'Feb', weeks: 4, color: 'bg-slate-700' }, { name: 'Mar', weeks: 5, color: 'bg-slate-800' },
            { name: 'Abr', weeks: 4, color: 'bg-slate-600' }, { name: 'May', weeks: 4, color: 'bg-slate-700' }, { name: 'Jun', weeks: 5, color: 'bg-slate-800' },
            { name: 'Jul', weeks: 4, color: 'bg-slate-600' }, { name: 'Ago', weeks: 4, color: 'bg-slate-700' }, { name: 'Sep', weeks: 5, color: 'bg-slate-800' },
            { name: 'Oct', weeks: 4, color: 'bg-slate-600' }, { name: 'Nov', weeks: 4, color: 'bg-slate-700' }, { name: 'Dic', weeks: 5, color: 'bg-slate-800' }
        ];

        // --- DYNAMIC DATE CALCULATIONS ---
        // Start view: begin from the current month and show next 4 months (wrap year)
        const today = new Date();
        let startMonthIndex = today.getMonth(); // start at current month (0-based)
        const visibleCount = 4; // show current month + 3 following months

        // Generate VISIBLE_MONTHS allowing wrap-around at year end
        const VISIBLE_MONTHS = [];
        for (let i = 0; i < visibleCount; i++) {
            VISIBLE_MONTHS.push(FULL_MONTHS_CONFIG[(startMonthIndex + i) % 12]);
        }

        // Calculate weeks before start month to offset rendering (weeks from Jan to month-1)
        let offsetWeeks = 0;
        for (let i = 0; i < startMonthIndex; i++) offsetWeeks += FULL_MONTHS_CONFIG[i].weeks;

        // Global constants for this view
        const OFFSET_WEEKS_INDEX = offsetWeeks;
        const VISIBLE_TOTAL_WEEKS = VISIBLE_MONTHS.reduce((acc, m) => acc + m.weeks, 0);
        const MAX_YEAR_WEEKS = 52; // Total weeks in full year for data array

        // Get global references
        const taskContainer = document.getElementById('taskListContainer');
        const ganttContainer = document.getElementById('ganttGridContainer');
        let _scrollSyncInitialized = false;

        // ========= HELPER FUNCTIONS =========
        function initHeaders() {
            const mHeader = document.getElementById('ganttMonthsHeader');
            const wHeader = document.getElementById('ganttWeeksHeader');
            mHeader.innerHTML = ''; wHeader.innerHTML = '';

            // columnIndex is the zero-based index relative to the visible grid start
            let columnIndex = 0;

            VISIBLE_MONTHS.forEach(m => {
                const monthDiv = document.createElement('div');
                monthDiv.className = `gantt-header-month ${m.color} text-xs tracking-wider`;
                monthDiv.style.width = `${m.weeks * 20}px`;
                monthDiv.textContent = m.name;
                mHeader.appendChild(monthDiv);

                for (let i = 0; i < m.weeks; i++) {
                    const weekDiv = document.createElement('div');
                    weekDiv.className = 'flex items-center justify-center text-[9px] text-slate-400 font-medium border-r border-slate-200';
                    weekDiv.style.width = '20px';
                    // Calculate absolute week index from start of year (0-based), then display 1-based week number
                    const absoluteWeek = (OFFSET_WEEKS_INDEX + columnIndex) % MAX_YEAR_WEEKS;
                    const displayWeek = absoluteWeek + 1; // week numbers: 1..52
                    weekDiv.textContent = `${displayWeek}`;
                    wHeader.appendChild(weekDiv);
                    columnIndex++;
                }
            });
            const fullWidth = VISIBLE_TOTAL_WEEKS * 20;
            mHeader.style.minWidth = `${fullWidth}px`; wHeader.style.minWidth = `${fullWidth}px`;
            return fullWidth;
        }
        
        const FULL_WIDTH_PX = initHeaders();

        function syncRowHeights() {
            const leftScroll = taskContainer;
            const rightScroll = ganttContainer;
            const leftRows = leftScroll.querySelectorAll('.data-row');
            const rightRows = rightScroll.querySelectorAll('.data-row');

            // Batch all reads first, then all writes to avoid layout thrashing
            const heights = [];
            for (let i = 0; i < Math.min(leftRows.length, rightRows.length); i++) {
                const h = Math.max(leftRows[i].offsetHeight, rightRows[i].offsetHeight, 48);
                heights.push(h);
            }
            // Now batch write all at once
            for (let i = 0; i < heights.length; i++) {
                leftRows[i].style.height = `${heights[i]}px`;
                rightRows[i].style.height = `${heights[i]}px`;
            }

            // Attach scroll sync listeners once to avoid many handlers
            if (!_scrollSyncInitialized) {
                let isSyncingScroll = false;
                rightScroll.addEventListener('scroll', () => {
                    if (isSyncingScroll) return;
                    isSyncingScroll = true;
                    leftScroll.scrollTop = rightScroll.scrollTop;
                    requestAnimationFrame(() => { isSyncingScroll = false; });
                }, { passive: true });

                leftScroll.addEventListener('scroll', () => {
                    if (isSyncingScroll) return;
                    isSyncingScroll = true;
                    rightScroll.scrollTop = leftScroll.scrollTop;
                    requestAnimationFrame(() => { isSyncingScroll = false; });
                }, { passive: true });

                _scrollSyncInitialized = true;
            }
        }

        function getTodayFormatted() {
            const d = new Date();
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yyyy = d.getFullYear();
            return `${dd}/${mm}/${yyyy}`;
        }

        function dateToWeekNumber(dateStr) {
            if (!dateStr) return -1;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return -1;
            const d = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
            const startOfYear = new Date(d.getFullYear(), 0, 1);
            const diff = d - startOfYear;
            // Return 1-based week number (weeks starting at day 1..7 => week 1)
            return Math.floor(diff / (1000 * 60 * 60 * 24 * 7)) + 1;
        }

        // Zero-based week index for internal array indexing (0..51)
        function dateToWeekIndex(dateStr) {
            if (!dateStr) return -1;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return -1;
            const d = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
            const startOfYear = new Date(d.getFullYear(), 0, 1);
            const diff = d - startOfYear;
            return Math.floor(diff / (1000 * 60 * 60 * 24 * 7));
        }

        function dateToISO(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('/');
            if(parts.length < 3) return '';
            const day = parts[0].padStart(2, '0');
            const month = parts[1].padStart(2, '0');
            const year = parts[2];
            return `${year}-${month}-${day}`;
        }

        function dateFromISO(isoStr) {
            if (!isoStr) return '';
            const [year, month, day] = isoStr.split('-');
            return `${day}/${month}/${year}`;
        }
        function formatDateDMY(str) {
            if (!str) return '';
            // ISO format: yyyy-mm-dd
            if (str.includes('-')) {
                const parts = str.split('-');
                if (parts.length === 3) {
                    const [y, m, d] = parts;
                    return `${String(d).padStart(2, '0')}/${String(m).padStart(2, '0')}/${y}`;
                }
            }
            // Slash format: try dd/mm/yyyy or yyyy/mm/dd
            if (str.includes('/')) {
                const parts = str.split('/');
                if (parts.length === 3) {
                    // if first part is 4 chars treat as yyyy/mm/dd
                    if (parts[0].length === 4) {
                        return `${String(parts[2]).padStart(2, '0')}/${String(parts[1]).padStart(2, '0')}/${parts[0]}`;
                    }
                    return `${String(parts[0]).padStart(2, '0')}/${String(parts[1]).padStart(2, '0')}/${parts[2]}`;
                }
            }
            // Fallback: try Date parse
            const d = new Date(str);
            if (!isNaN(d)) return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
            return str;
        }
        function sortDateValue(dateStr) {
            if (!dateStr) return Number.POSITIVE_INFINITY;
            const normalized = formatDateDMY(dateStr);
            const parts = normalized.split('/');
            if (parts.length !== 3) return Number.POSITIVE_INFINITY;
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            const year = parseInt(parts[2], 10);
            if (!Number.isFinite(day) || !Number.isFinite(month) || !Number.isFinite(year)) return Number.POSITIVE_INFINITY;
            if (day < 1 || day > 31 || month < 0 || month > 11 || year < 1900) return Number.POSITIVE_INFINITY;
            const ts = new Date(year, month, day).getTime();
            return Number.isNaN(ts) ? Number.POSITIVE_INFINITY : ts;
        }
        function padGantt(arr) {
            // Ensure data array is full year length (52)
            const currentLen = arr.length;
            if (currentLen < MAX_YEAR_WEEKS) return [...arr, ...new Array(MAX_YEAR_WEEKS - currentLen).fill(0)];
            return arr.slice(0, MAX_YEAR_WEEKS);
        }
        function calculateProjectStatus(tasks) {
            if (!tasks || tasks.length === 0) return 1; 
            const allTerminated = tasks.every(t => t.status === 3);
            if (allTerminated) return 3; 
            const anyInProgress = tasks.some(t => t.status === 2);
            if (anyInProgress) return 2; 
            return 1; 
        }
        function calculateProjectType(tasks) {
            if (!tasks || tasks.length === 0) return 'Proceso';
            const typeCounts = {};
            tasks.forEach(t => { const tipo = t.tipo || 'Proceso'; typeCounts[tipo] = (typeCounts[tipo] || 0) + 1; });
            let mostFrequent = 'Proceso', maxCount = 0;
            for (const [tipo, count] of Object.entries(typeCounts)) {
                if (count > maxCount) { maxCount = count; mostFrequent = tipo; }
            }
            return mostFrequent;
        }
        function getStatusFromText(text) {
            const status = String(text).toUpperCase();
            if (status.includes('PENDIENTE')) return 1;
            if (status.includes('PROCESO')) return 2;
            if (status.includes('TERMINADO')) return 3;
            return 1;
        }
        function calculateEndWeekFromGantt(ganttArray) {
            let lastPaintedIndex = -1;
            for (let i = ganttArray.length - 1; i >= 0; i--) { if (ganttArray[i] > 0) { lastPaintedIndex = i; break; } }
            return lastPaintedIndex === -1 ? "" : lastPaintedIndex + 1; 
        }

        // ========= UI FUNCTIONS =========
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'success' ? 'success' : type === 'error' ? 'error' : ''}`;
            const icon = type === 'success' ? 'fa-check-circle text-emerald-500' : type === 'error' ? 'fa-exclamation-circle text-red-500' : 'fa-info-circle';
            toast.innerHTML = `<i class="fa-solid ${icon}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }
        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmModal').style.display = 'flex';
        }
        function closeConfirmModal() { document.getElementById('confirmModal').style.display = 'none'; confirmCallback = null; }
        document.getElementById('confirmBtnAction').addEventListener('click', () => { if (confirmCallback) confirmCallback(); closeConfirmModal(); });

        function isPriorityProject(p) {
            // Un proyecto es prioridad si su campo PRIORIDAD es "ALTA" (case-insensitive)
            const prioridad = (p.prioridad || '').toUpperCase().trim();
            return prioridad === 'ALTA';
        }

        function matchesFilters(p) {
            const status = calculateProjectStatus(p.tasks);
            if (!SHOW_COMPLETED && status === 3) return false; 
            if (SHOW_PRIORITY && !isPriorityProject(p)) return false;
            
            // Month Filter Check (Range Overlap)
            if (FILTERS.month !== 'all') {
                const mi = parseInt(FILTERS.month, 10);
                const { start: mStart, end: mEnd } = getMonthRange(mi);

                const pStartW = dateToWeekIndex(p.inicio);
                // Calculate Project Duration based on Tasks
                let pEndW = -1;
                
                // If project has tasks, check their range
                if (p.tasks && p.tasks.length > 0) {
                     let maxTaskEnd = -1;
                     p.tasks.forEach(t => {
                         let tEnd = t.gantt.lastIndexOf(1);
                         if(tEnd > maxTaskEnd) maxTaskEnd = tEnd;
                     });
                     if(maxTaskEnd > -1) pEndW = maxTaskEnd;
                     else pEndW = p.gantt.lastIndexOf(1);
                } else {
                     pEndW = p.gantt.lastIndexOf(1);
                }

                if (pEndW < pStartW) pEndW = pStartW; 

                // Overlap Check: (Start <= FilterEnd) AND (End >= FilterStart)
                if (!(pStartW <= mEnd && pEndW >= mStart)) return false;
            }

            if (FILTERS.area && p.area !== FILTERS.area) return false;
            if (FILTERS.project && p.nombre !== FILTERS.project) return false;
            return true;
        }

        function togglePriority() {
            SHOW_PRIORITY = !SHOW_PRIORITY;
            const btn = document.getElementById('btn-priority');
            if(SHOW_PRIORITY) {
                btn.classList.add('btn-priority-active');
                document.getElementById('filter-area').value = '';
                document.getElementById('filter-project').value = '';
                FILTERS.area = ''; FILTERS.project = '';
            } else { btn.classList.remove('btn-priority-active'); }
            render();
        }

        function toggleShowCompleted() {
            SHOW_COMPLETED = !SHOW_COMPLETED;
            const btn = document.getElementById('btn-show-complete');
            if (SHOW_COMPLETED) {
                btn.classList.add('btn-priority-active');
                btn.textContent = 'Ocultar completados';
            } else {
                btn.classList.remove('btn-priority-active');
                btn.textContent = 'Ver completo';
            }
            render();
        }

        function populateFilterOptions() {
            // Month filter removed
            const areaSel = document.getElementById('filter-area');
            const projectSel = document.getElementById('filter-project');
            const areas = Array.from(new Set(projectData.map(p => p.area).filter(a => a)));
            areaSel.innerHTML = '<option value="">Todas las áreas</option>' + areas.map(a => `<option value="${a}">${a}</option>`).join('');
            const projects = Array.from(new Set(projectData.map(p => p.nombre).filter(n => n)));
            projectSel.innerHTML = '<option value="">Buscar proyecto (todos)</option>' + projects.map(n => `<option value="${n}">${n}</option>`).join('');
            areaSel.addEventListener('change', (e) => { FILTERS.area = e.target.value; render(); });
            projectSel.addEventListener('change', (e) => { FILTERS.project = e.target.value; render(); });
        }

        // ========= MAIN RENDER =========
        function render() {
            const taskContainer = document.getElementById('taskListContainer');
            const ganttContainer = document.getElementById('ganttGridContainer');
            taskContainer.innerHTML = '';
            ganttContainer.innerHTML = '';
            ganttContainer.style.minWidth = '100%';
            
            const ganttContent = document.createElement('div');
            ganttContent.style.minWidth = `${FULL_WIDTH_PX}px`;
            
            // Use DocumentFragment for batch insertion
            const taskFragment = document.createDocumentFragment();
            const ganttFragment = document.createDocumentFragment();

            projectData.filter(p => matchesFilters(p)).forEach(p => {
                const calculatedStatus = calculateProjectStatus(p.tasks);
                const calculatedType = calculateProjectType(p.tasks);
                const statusClass = STATUS_BADGE_CLASSES[calculatedStatus];
                const statusText = {1: 'PENDIENTE', 2: 'EN PROCESO', 3: 'TERMINADO'}[calculatedStatus];

                const pRowLeft = document.createElement('div');
                pRowLeft.className = `data-row project-row cursor-pointer group`; 
                pRowLeft.innerHTML = `
                    <div class="cell col-icon group-hover:text-blue-600 transition" onclick="toggleProject('${p.id}')"><i class="fa-solid fa-chevron-${p.expanded ? 'down' : 'right'}"></i></div>
                    <div class="cell col-area text-blue-700">${p.area}</div>
                    <div class="cell col-tipo text-xs font-bold text-slate-700">${calculatedType}</div>
                    <div class="cell col-estado"><div class="status-badge-select ${statusClass}" style="cursor: default; pointer-events: none;">${statusText}</div></div>
                    <div class="cell col-inicio">
                        <input type="date" class="table-input text-center font-bold" value="${dateToISO(p.inicio)}" onchange="updateProjectDate('${p.id}', dateFromISO(this.value))" onclick="event.stopPropagation()">
                    </div>
                    <div class="cell col-nombre font-bold text-slate-700 group-hover:text-blue-800 transition"><span onclick="toggleProject('${p.id}')">${p.nombre}</span></div>
                    <div class="cell col-prioridad"><i class="fa-solid fa-star priority-indicator ${isPriorityProject(p) ? 'priority-alta' : 'priority-baja'}" title="${p.prioridad || 'BAJA'}"></i></div>
                    <div class="cell col-gestor">${p.gestor || ''}</div>
                    <div class="cell col-ejecutor font-bold text-slate-600"></div>
                    <div class="cell col-acciones">
                        <button onclick="event.stopPropagation(); openKpiModal('${p.id}')" class="action-btn text-xs text-emerald-600 hover:text-emerald-700" title="Ver KPIs"><i class="fa-solid fa-chart-pie"></i></button>
                        <button onclick="event.stopPropagation(); openCreateTaskModal('${p.id}')" class="action-btn text-xs text-blue-600 hover:text-blue-700" title="Agregar Tarea"><i class="fa-solid fa-plus"></i></button>
                    </div>
                `;
                taskContainer.appendChild(pRowLeft);

                const pRowRight = document.createElement('div');
                pRowRight.className = 'data-row project-row relative';
                
                let minStart = 9999, maxEnd = -1, totalPoints = 0, earnedPoints = 0;
                let completedCount = 0;
                
                p.tasks.forEach(t => {
                    if (t.status === 3) completedCount++;
                    if (t.gantt.some(x => x > 0)) {
                        totalPoints++;
                        if (t.status === 2) earnedPoints += 0.5;
                        if (t.status === 3) earnedPoints += 1;
                    }
                    const mm = getGanttMinMax(t.gantt);
                    if (mm.max > -1) {
                        if (mm.min < minStart) minStart = mm.min;
                        if (mm.max > maxEnd) maxEnd = mm.max;
                    }
                });

                // Render progress bar for project if there are tasks with gantt data
                if (totalPoints > 0 && minStart <= maxEnd && maxEnd >= OFFSET_WEEKS_INDEX && minStart <= (OFFSET_WEEKS_INDEX + VISIBLE_TOTAL_WEEKS - 1)) {
                    const viewStartIdx = OFFSET_WEEKS_INDEX;
                    const viewEndIdx = OFFSET_WEEKS_INDEX + VISIBLE_TOTAL_WEEKS - 1;
                    const drawStart = Math.max(minStart, viewStartIdx);
                    const drawEnd = Math.min(maxEnd, viewEndIdx);
                    const leftPx = (drawStart - viewStartIdx) * 20;
                    const widthPx = (drawEnd - drawStart + 1) * 20;
                    const totalCount = p.tasks.length;
                    const progressPct = Math.round((completedCount / totalCount) * 100);
                    
                    const barContainer = document.createElement('div');
                    barContainer.className = 'absolute top-1/2 -translate-y-1/2 h-5 bg-slate-200 rounded text-xs font-bold text-slate-700 flex items-center justify-center z-20 pointer-events-none overflow-visible whitespace-nowrap shadow-sm border border-slate-300';
                    barContainer.style.left = `${leftPx}px`;
                    barContainer.style.width = `${widthPx}px`;
                    
                    barContainer.innerHTML = `
                        <div class="absolute left-0 top-0 h-full bg-blue-400 rounded-l transition-all duration-700 opacity-80 flex items-center justify-center overflow-hidden" style="width: ${progressPct}%; border-radius: inherit;">
                            <span class="z-10 px-2 drop-shadow-md text-[10px] text-white font-semibold truncate">${completedCount}/${totalCount} • ${progressPct}%</span>
                        </div>
                    `;
                    pRowRight.appendChild(barContainer);
                }

                if (!p.gantt) p.gantt = new Array(MAX_YEAR_WEEKS).fill(0);
                
                // Render cells
                for(let i=0; i<VISIBLE_TOTAL_WEEKS; i++) {
                    const actualWeekIdx = OFFSET_WEEKS_INDEX + i;
                    const cell = document.createElement('div');
                    cell.className = 'gantt-week-col z-10';
                    cell.onclick = (e) => toggleCell(p.id, -1, i); 
                    pRowRight.appendChild(cell);
                }
                taskFragment.appendChild(pRowLeft);
                ganttFragment.appendChild(pRowRight);

                if (p.expanded) {
                    const tasksForRender = p.tasks
                        .map((t, tIndex) => ({ t, tIndex, sortKey: sortDateValue(t.inicio || p.inicio) }))
                        .sort((a, b) => (a.sortKey - b.sortKey) || (a.tIndex - b.tIndex));
                    tasksForRender.forEach(({ t, tIndex }) => {
                        // TASK VISIBILITY FILTER (Inside Project)
                        // Hide finished tasks unless SHOW_COMPLETED is enabled
                        if (t.status === 3 && !SHOW_COMPLETED) return;
                        let showTask = true;
                        
                        const viewStartIdx = OFFSET_WEEKS_INDEX;
                        const viewEndIdx = OFFSET_WEEKS_INDEX + VISIBLE_TOTAL_WEEKS - 1;
                        
                        const taskStartW = dateToWeekIndex(t.inicio);
                        let taskEndW = t.gantt.lastIndexOf(1);
                        if (taskEndW < taskStartW) taskEndW = taskStartW;
                        
                        // If SHOW_ALL_TASKS is true we always list the task in the left panel
                        if (!SHOW_ALL_TASKS) {
                            if (taskEndW < viewStartIdx || taskStartW > viewEndIdx) {
                                showTask = false;
                            }
                        }

                        if (!showTask) return;

                        const tRowLeft = document.createElement('div');
                        tRowLeft.className = 'data-row hover:bg-slate-50';
                        const tStatus = t.status || 1; 
                        const statusSelectTask = `<select class="status-badge-select ${STATUS_BADGE_CLASSES[tStatus]}" onchange="updateTaskStatus('${p.id}', ${tIndex}, this.value)" onclick="event.stopPropagation()"><option value="1" ${tStatus == 1 ? 'selected' : ''}>Pendiente</option><option value="2" ${tStatus == 2 ? 'selected' : ''}>En Proceso</option><option value="3" ${tStatus == 3 ? 'selected' : ''}>Terminado</option></select>`;
                        const taskTipoOptions = PROJECT_TYPES.map(type => `<option value="${type}" ${ (t.tipo || PROJECT_TYPES[0]) === type ? 'selected' : ''}>${type}</option>`).join('');
                        const tipoSelectTask = `<select class="table-input" style="font-size:0.7rem;" onchange="updateTaskType('${p.id}', ${tIndex}, this.value)" onclick="event.stopPropagation()">${taskTipoOptions}</select>`;

                        tRowLeft.innerHTML = `
                            <div class="cell col-icon"></div><div class="cell col-area"></div>
                            <div class="cell col-tipo">${tipoSelectTask}</div><div class="cell col-estado">${statusSelectTask}</div>
                            <div class="cell col-inicio"><input type="date" class="table-input text-center font-bold text-xs" value="${dateToISO(t.inicio || p.inicio)}" onchange="updateTaskDate('${p.id}', ${tIndex}, dateFromISO(this.value))" onclick="event.stopPropagation()"></div>
                            <div class="cell col-nombre pl-6 text-sm"><span class="tree-line-v"></span><span class="tree-line-h"></span><div class="tree-connector"></div>${t.nombre}</div>
                            <div class="cell col-prioridad"></div>
                            <div class="cell col-gestor"></div>
                            <div class="cell col-ejecutor text-xs text-slate-500">${t.ejecutor}</div>
                            <div class="cell col-acciones">
                                <button onclick="event.stopPropagation(); openEditTaskModal('${p.id}', ${tIndex})" class="text-slate-500 hover:text-blue-600 p-1.5 transition"><i class="fa-solid fa-pen-to-square"></i></button>
                                <button onclick="event.stopPropagation(); deleteTaskConfirm('${p.id}', ${tIndex})" class="text-slate-400 hover:text-red-500 p-1.5 transition"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        `;
                        taskFragment.appendChild(tRowLeft);

                        const tRowRight = document.createElement('div');
                        tRowRight.className = 'data-row hover:bg-slate-50 relative';
                        
                        // --- Draw Continuous Bar for Tasks ---
                        let tMin = 9999, tMax = -1;
                        t.gantt.forEach((v, idx) => { if (v > 0) { if (idx < tMin) tMin = idx; if (idx > tMax) tMax = idx; } });

                        if (tMin <= tMax && tMax >= viewStartIdx && tMin <= viewEndIdx) {
                            const drawStart = Math.max(tMin, viewStartIdx);
                            const drawEnd = Math.min(tMax, viewEndIdx);
                            const leftPx = (drawStart - viewStartIdx) * 20;
                            const widthPx = (drawEnd - drawStart + 1) * 20;
                            
                            const barColorClass = STATE_COLORS[tStatus] || 'bg-blue-400';

                            const bar = document.createElement('div');
                            bar.className = `absolute top-1/2 -translate-y-1/2 h-6 ${barColorClass} rounded shadow-sm z-0 pointer-events-none transition-all duration-300 opacity-80`;
                            bar.style.left = `${leftPx + 2}px`; 
                            bar.style.width = `${widthPx - 4}px`; 
                            
                            tRowRight.appendChild(bar);
                        }

                        // Render clickable cells
                        for(let i=0; i<VISIBLE_TOTAL_WEEKS; i++) {
                            const actualWeekIdx = OFFSET_WEEKS_INDEX + i;
                            
                            const cell = document.createElement('div');
                            cell.className = 'gantt-week-col';
                            cell.onclick = (e) => toggleCell(p.id, tIndex, i);
                            tRowRight.appendChild(cell);
                        }
                        ganttFragment.appendChild(tRowRight);
                    });
                }
            });
            // Batch append fragments to avoid multiple reflows
            ganttContent.appendChild(ganttFragment);
            ganttContainer.appendChild(ganttContent);
            taskContainer.appendChild(taskFragment);
            setTimeout(syncRowHeights, 0); 
        }

        // ========= INTERACTION FUNCTIONS (Saving/Updating) =========
        function updateTaskStatus(pid, tidx, val) { const p = projectMap.get(pid); if(p && p.tasks[tidx]) { p.tasks[tidx].status = parseInt(val); saveToSheetAsync(pid, tidx); scheduleRender(); } }
        function updateTaskType(pid, tidx, val) { const p = projectMap.get(pid); if(p && p.tasks[tidx]) { p.tasks[tidx].tipo = val; saveToSheetAsync(pid, tidx); } }
        function updateTaskDate(pid, tidx, val) {
            const p = projectMap.get(pid);
            if (p && p.tasks[tidx]) {
                const t = p.tasks[tidx];
                t.inicio = val;
            const startWeek = dateToWeekIndex(val);
                if (!(startWeek >= 0 && startWeek < MAX_YEAR_WEEKS)) { saveToSheetAsync(pid, tidx); scheduleRender(); return; }

                // Determine current painted length (continuous block) to preserve duration
                let curMin = -1, curMax = -1;
                for (let i = 0; i < MAX_YEAR_WEEKS; i++) {
                    if (t.gantt && t.gantt[i] > 0) {
                        if (curMin === -1) curMin = i;
                        curMax = i;
                    }
                }
                let length = 1;
                if (curMin !== -1 && curMax !== -1) length = Math.max(1, curMax - curMin + 1);

                const newGantt = new Array(MAX_YEAR_WEEKS).fill(0);
                const endIdx = Math.min(MAX_YEAR_WEEKS - 1, startWeek + length - 1);
                for (let i = startWeek; i <= endIdx; i++) newGantt[i] = 1;
                t.gantt = newGantt;

                saveToSheetAsync(pid, tidx);
                scheduleRender();
            }
        }
        function updateProjectDate(pid, val) {
            const p = projectMap.get(pid);
            if (p) {
                const oldInicio = p.inicio;
                p.inicio = val;
                const startWeek = dateToWeekIndex(val);
                if (!(startWeek >= 0 && startWeek < MAX_YEAR_WEEKS)) { scheduleRender(); return; }

                // Preserve existing painted span length for project gantt
                if (!p.gantt) p.gantt = new Array(MAX_YEAR_WEEKS).fill(0);
                let curMin = -1, curMax = -1;
                for (let i = 0; i < MAX_YEAR_WEEKS; i++) {
                    if (p.gantt[i] > 0) {
                        if (curMin === -1) curMin = i;
                        curMax = i;
                    }
                }
                let length = 1;
                if (curMin !== -1 && curMax !== -1) length = Math.max(1, curMax - curMin + 1);

                const newGantt = new Array(MAX_YEAR_WEEKS).fill(0);
                const endIdx = Math.min(MAX_YEAR_WEEKS - 1, startWeek + length - 1);
                for (let i = startWeek; i <= endIdx; i++) newGantt[i] = 1;
                p.gantt = newGantt;

                scheduleRender();
            }
        }
        
        function toggleCell(pid, tidx, wIndex) {
            const p = projectMap.get(pid); if (!p) return;
            
            const target = (tidx === -1) ? p : p.tasks[tidx];
            let startDate = target.inicio;
            if (tidx >= 0 && !startDate) startDate = p.inicio;
            if (!startDate) { showToast('Establece fecha inicio primero', 'error'); return; }

            // Map visual click (0..N) to actual year week (0..51)
            const actualClickWeek = OFFSET_WEEKS_INDEX + wIndex;

            // Use zero-based week index helper to avoid 0/1-based mismatch
            let startWeek = dateToWeekIndex(startDate);
            if (startWeek === -1) startWeek = 0;

            if (actualClickWeek < startWeek) {
                showToast('No puedes programar antes de la fecha de inicio', 'error');
                return;
            }

            // Continuous bar: reset and fill range
            const newGantt = new Array(MAX_YEAR_WEEKS).fill(0);

            const startIdx = Math.max(0, startWeek);
            const endIdx = Math.min(MAX_YEAR_WEEKS - 1, actualClickWeek);

            for (let i = startIdx; i <= endIdx; i++) {
                newGantt[i] = 1;
            }
            target.gantt = newGantt;

            if (tidx !== -1) {
                saveToSheetAsync(pid, tidx);
            }
            scheduleRender();
        }

        function toggleProject(pid) { const p = projectMap.get(pid); if (p) { p.expanded = !p.expanded; scheduleRender(); } }
        function toggleAll(expand) { projectData.forEach(p => p.expanded = expand); scheduleRender(); }
        
        // Debounced render to avoid multiple renders in quick succession
        function scheduleRender() {
            if (renderScheduled) return;
            renderScheduled = true;
            requestAnimationFrame(() => { renderScheduled = false; render(); });
        }
        
        // Fast gantt min/max calculator with caching
        function getGanttMinMax(gantt) {
            const key = gantt.join(',');
            if (ganttMinMaxCache.has(key)) return ganttMinMaxCache.get(key);
            let min = 9999, max = -1;
            for (let i = 0; i < gantt.length; i++) {
                if (gantt[i] > 0) {
                    if (i < min) min = i;
                    if (i > max) max = i;
                }
            }
            const result = { min, max };
            ganttMinMaxCache.set(key, result);
            return result;
        }

        // Update project lookup map for fast O(1) access
        function updateProjectMap() {
            projectMap.clear();
            projectData.forEach(p => projectMap.set(p.id, p));
        }

        async function fetchColumnFromSheet(columnName) {
            try { const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'fetchColumnValues', columnName: columnName }) });
            if (!response.ok) return []; const result = await response.json(); return result || []; } catch(e) { console.warn(e); return []; }
        }
        
        // Extraer columnas directamente de los datos ya cargados (sin fetch adicional)
        function refreshCachedColumns() {
            const areasSet = new Set();
            const ejecutoresSet = new Set();
            
            projectData.forEach(p => {
                if (p.area && String(p.area).trim()) areasSet.add(String(p.area).trim());
                if (p.tasks) {
                    p.tasks.forEach(t => {
                        if (t.ejecutor && String(t.ejecutor).trim()) ejecutoresSet.add(String(t.ejecutor).trim());
                    });
                }
            });
            
            cachedColumns.areas = Array.from(areasSet);
            cachedColumns.ejecutores = ejecutoresSet.size > 0 ? Array.from(ejecutoresSet) : ['EO', 'Equipo', 'Externo'];
            columnsCacheLoaded = true;
            console.log('Columnas extraídas de datos:', cachedColumns);
        }

        async function saveToSheetAsync(pid, tidx) {
            const p = projectMap.get(pid); if (!p) return;
            const task = tidx >= 0 ? p.tasks[tidx] : null;
            const statusText = task ? {1: 'PENDIENTE', 2: 'EN PROCESO', 3: 'TERMINADO'}[task.status] : {1: 'PENDIENTE', 2: 'EN PROCESO', 3: 'TERMINADO'}[p.status];
            const currentGantt = task ? task.gantt : p.gantt;
            const currentStart = task ? dateToISO(task.inicio) : dateToISO(p.inicio);
            const calculatedEndWeek = calculateEndWeekFromGantt(currentGantt);
            const calculatedStartSheet = dateFromISO(currentStart); 
            const taskObj = { 
              area: p.area, 
              proyecto: p.nombre, 
              tarea: task ? task.nombre : '', 
              prioridad: task ? task.prioridad : p.prioridad || '',
              tipo: task ? task.tipo : p.tipo, 
              estado: statusText, 
              gestor: p.gestor,
              ejecutor: task ? task.ejecutor : p.ejecutor, 
              f_inicio: calculatedStartSheet, 
              f_fin: calculatedEndWeek 
            };
            try { await fetch(APPS_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'saveTaskData', payload: taskObj }) }); } catch(e) { console.error('Error guardando en Sheet:', e); }
        }

        async function deleteTaskAsync(area, proyecto, tarea) {
            try { await fetch(APPS_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'deleteTaskData', payload: { area, proyecto, tarea } }) }); } catch(e) { console.error(e); }
        }

        // ========= MODALS LOGIC =========
        
        // --- Open Modal Wrapper ---
        function openModal(mode, projectObj = null) {
            createMode = mode; // 'project' or 'task'
            targetProjectId = projectObj ? projectObj.id : null;
            
            const modal = document.getElementById('createFieldModal');
            const titleEl = document.getElementById('cf-modal-title');
            const subtitleEl = document.getElementById('cf-modal-subtitle');
            
            // Refrescar columnas desde datos ya cargados (instantáneo, sin fetch)
            refreshCachedColumns();
            
            // Poblar dropdown de AREA desde datos del Excel (columna AREA de hoja Datos)
            const $area = document.getElementById('cf-area');
            $area.innerHTML = '<option value="">-- Seleccione área --</option>' + 
                cachedColumns.areas.map(a => `<option value="${a}">${a}</option>`).join('');
            
            // Poblar dropdown de EJECUTOR desde datos del Excel (columna EJECUTOR de hoja Datos)
            const $exec = document.getElementById('cf-ejecutor');
            $exec.innerHTML = '<option value="">-- Seleccione --</option>' + 
                cachedColumns.ejecutores.map(e => `<option value="${e}">${e}</option>`).join('');

            // Poblar dropdown de TIPO
            const $tipo = document.getElementById('cf-tipo');
            $tipo.innerHTML = PROJECT_TYPES.map(t => `<option value="${t}">${t}</option>`).join('');

            // Toggle visibility based on mode
            const divProjInput = document.getElementById('div-cf-project-input');
            const divProjReadonly = document.getElementById('div-cf-project-select');
            const divGestor = document.getElementById('div-cf-gestor');
            const divTask = document.getElementById('div-cf-task');
            const divTaskReadonly = document.getElementById('div-cf-task-readonly');
            const divExec = document.getElementById('div-cf-ejecutor');
            const divPrioridad = document.getElementById('div-cf-prioridad');
            
            if (mode === 'project') {
                titleEl.textContent = "CREAR NUEVO PROYECTO";
                subtitleEl.textContent = "Definir nuevo proyecto maestro";
                
                divProjInput.style.display = 'block';
                divProjReadonly.style.display = 'none';
                divGestor.style.display = 'block'; // Show Gestor
                divTask.style.display = 'block';    // Show editable Task name
                divTaskReadonly.style.display = 'none'; // Hide readonly Task
                divExec.style.display = 'none';    // Hide Executor
                divPrioridad.style.display = 'block'; // Show Prioridad
                
                // Clear fields
                document.getElementById('cf-project-input').value = "";
                document.getElementById('cf-gestor').value = "";
                document.getElementById('cf-task').value = "";
                $area.value = "";
                $area.disabled = false;
                
            } else { // mode === 'task'
                titleEl.textContent = "AGREGAR TAREA";
                subtitleEl.textContent = `Al proyecto: ${projectObj.nombre}`;
                
                divProjInput.style.display = 'none';
                divProjReadonly.style.display = 'block';
                divGestor.style.display = 'none';  // Hide Gestor (inherited)
                divTask.style.display = 'block';    // Show editable Task name
                divTaskReadonly.style.display = 'none'; // Hide readonly Task
                divExec.style.display = 'block';   // Show Executor
                divPrioridad.style.display = 'block'; // Show Prioridad
                
                // Pre-fill fields
                document.getElementById('cf-project-readonly').value = projectObj.nombre;
                document.getElementById('cf-task').value = '';
                $area.value = projectObj.area;
                $area.disabled = true; // Lock Area
            }

            // Default Date
            const today = new Date().toISOString().split('T')[0]; 
            document.getElementById('cf-inicio').value = today;

            modal.style.display = 'flex';
        }

        // --- Trigger for New Project ---
        document.getElementById('create-project-button')?.addEventListener('click', () => {
             openModal('project');
        });
        
        // --- Trigger for New Task (called from render loop) ---
        function openCreateTaskModal(projectId) {
            const p = projectMap.get(projectId);
            if (p) openModal('task', p); // No await, la tarea se abre rápido
        }

        document.getElementById('createFieldClose')?.addEventListener('click', () => document.getElementById('createFieldModal').style.display='none');
        document.getElementById('cf-cancel')?.addEventListener('click', () => document.getElementById('createFieldModal').style.display='none');
        
        // --- SAVE LOGIC ---
        document.getElementById('cf-save')?.addEventListener('click', async () => {
            const area = document.getElementById('cf-area').value || 'GENERAL'; 
            const tipo = document.getElementById('cf-tipo').value || 'Proceso';
            const prioridad = document.getElementById('cf-prioridad').value || 'BAJA';
            let inicioInput = document.getElementById('cf-inicio').value;
            if (!inicioInput) { const d = new Date(); inicioInput = d.toISOString().split('T')[0]; }
            let inicio = inicioInput;
            
            // Logic split
            let proyecto = "";
            let tarea = "";
            let ejecutor = "";
            let gestor = "";

            if (createMode === 'project') {
                proyecto = (document.getElementById('cf-project-input').value || 'Nuevo Proyecto').trim();
                tarea = ""; 
                gestor = (document.getElementById('cf-gestor').value || '').trim();
                ejecutor = ""; 
            } else {
                // Task Mode - usar projectMap en lugar de .find() para O(1) lookup
                const p = projectMap.get(targetProjectId);
                proyecto = p.nombre;
                gestor = p.gestor || ""; // Inherit
                tarea = (document.getElementById('cf-task').value || 'Nueva Tarea').trim();
                ejecutor = (document.getElementById('cf-ejecutor').value || 'Equipo').trim();
            }

            // Format date
            if (inicio.includes('-')) { const [y, m, d] = inicio.split('-'); inicio = `${d}/${m}/${y}`; }
            const semanaInicioIdx = dateToWeekIndex(inicio);
            
            // Local Update
            const ganttArr = padGantt([1]); 
            const fFinCalculada = semanaInicioIdx + 1; 

            if (createMode === 'project') {
                const newId = 'u' + Date.now();
                const newProject = {
                    id: newId, area, tipo, prioridad: prioridad, inicio, nombre: proyecto, ejecutor: "", gestor: gestor, expanded: false, 
                    tasks: [], gantt: ganttArr, kpis: []
                };
                projectData.push(newProject);
                projectMap.set(newId, newProject);
            } else {
                const p = projectMap.get(targetProjectId);
                if (p) {
                    const newTaskId = p.id + 't' + (p.tasks.length + 1);
                    p.tasks.push({ id: newTaskId, nombre: tarea, tipo, prioridad: prioridad, ejecutor, status: 1, gantt: ganttArr, inicio: inicio });
                }
            }

            const taskObj = { AREA: area, PROYECTO: proyecto, TAREA: tarea, PRIORIDAD: prioridad, TIPO: tipo, F_INICIO: inicio, EJECUTOR: ejecutor, GESTOR: gestor, ESTADO: 'Pendiente', F_FIN: fFinCalculada };
            
            // Actualizar UI inmediatamente (no esperar al servidor)
            scheduleRender();
            document.getElementById('createFieldModal').style.display = 'none';
            showToast(createMode === 'project' ? 'Proyecto creado' : 'Tarea agregada', 'success');
            
            // Guardar en background (fire and forget) sin bloquear UI
            fetch(APPS_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'saveTaskData', payload: taskObj }) })
                .then(r => r.json())
                .catch(e => { console.error('Error guardando:', e); showToast('Error: No se guardó en servidor', 'error'); });
        });

        // 2. Edit Task Modal (Existing Logic)
        function openEditTaskModal(pid, tidx) {
            const p = projectMap.get(pid); if (!p) return;
            const t = p.tasks[tidx]; if (!t) return;
            currentEdit = { pid, tidx };
            document.getElementById('edit-task-name').value = t.nombre;
            const typesSelect = document.getElementById('edit-task-tipo'); typesSelect.innerHTML = PROJECT_TYPES.map(type => `<option value="${type}">${type}</option>`).join(''); typesSelect.value = t.tipo || PROJECT_TYPES[0];
            document.getElementById('edit-task-estado').value = t.status || 1;
            document.getElementById('edit-task-inicio').value = dateToISO(t.inicio || p.inicio);
            document.getElementById('edit-task-ejecutor').value = t.ejecutor || p.ejecutor;
            document.getElementById('editTaskModal').style.display = 'flex';
        }
        function closeEditTaskModal() { document.getElementById('editTaskModal').style.display = 'none'; currentEdit = null; }
        function saveEditedTask() {
            if (!currentEdit) return;
            const { pid, tidx } = currentEdit; const p = projectMap.get(pid); if (!p) return; const t = p.tasks[tidx];
            t.nombre = document.getElementById('edit-task-name').value.trim() || t.nombre; t.tipo = document.getElementById('edit-task-tipo').value || t.tipo;
            t.status = parseInt(document.getElementById('edit-task-estado').value, 10) || t.status; t.inicio = dateFromISO(document.getElementById('edit-task-inicio').value) || t.inicio;
            t.ejecutor = document.getElementById('edit-task-ejecutor').value || t.ejecutor;
            saveToSheetAsync(pid, tidx); closeEditTaskModal(); scheduleRender(); showToast('Tarea actualizada', 'success');
        }
        function deleteTaskConfirm(pid, tidx) {
            const p = projectMap.get(pid); if (!p) return; const t = p.tasks[tidx]; if (!t) return;
            showConfirm(`¿Eliminar la tarea "${t.nombre}"?`, () => {
                p.tasks.splice(tidx, 1); deleteTaskAsync(p.area, p.nombre, t.nombre); scheduleRender(); showToast('Tarea eliminada', 'success');
            });
        }

        // 3. KPI Modal (Multi-KPI Reactivo)
        function openKpiModal(projectId) {
            const project = projectMap.get(projectId); if (!project) return;
            currentKpiProject = project;
            document.getElementById('kpiModalProjectTitle').innerText = `${project.nombre}`;
            if (!project.kpis || project.kpis.length === 0) {
                project.kpis = [{ id: 'new_' + Date.now(), objetivo: '', l_base: '', meta: '', indicador: '', numerador: '', denominador: '', monthly: {} }];
            }
            activeKpiIndex = 0; 
            renderKpiModalContent();
            document.getElementById('kpiModal').style.display = 'flex';
        }
        function closeKpiModal() { document.getElementById('kpiModal').style.display = 'none'; currentKpiProject = null; }

        function renderKpiModalContent() {
            renderKpiList();
            renderKpiForm();
        }

        function renderKpiList() {
            const container = document.getElementById('kpiListContainer'); container.innerHTML = '';
            currentKpiProject.kpis.forEach((kpi, idx) => {
                const div = document.createElement('div'); 
                div.className = `kpi-sidebar-item ${idx === activeKpiIndex ? 'active' : ''}`;
                
                // Title span
                const span = document.createElement('span');
                const title = kpi.objetivo || `Indicador ${idx + 1}`; 
                span.textContent = title.length > 18 ? title.substring(0, 18) + '...' : title;
                span.className = "flex-1";
                span.onclick = () => { activeKpiIndex = idx; renderKpiModalContent(); };

                // Actions div
                const actions = document.createElement('div');
                actions.className = "flex gap-2 opacity-60 hover:opacity-100";
                
                // Edit btn
                const btnEdit = document.createElement('i');
                btnEdit.className = "fa-solid fa-pencil hover:text-blue-600 p-1";
                btnEdit.onclick = (e) => { e.stopPropagation(); activeKpiIndex = idx; renderKpiModalContent(); };
                
                // Delete btn
                const btnDel = document.createElement('i');
                btnDel.className = "fa-solid fa-trash hover:text-red-600 p-1";
                btnDel.onclick = (e) => { e.stopPropagation(); deleteKpi(idx); };

                actions.appendChild(btnEdit);
                actions.appendChild(btnDel);
                div.appendChild(span);
                div.appendChild(actions);

                container.appendChild(div);
            });
        }
        
        function deleteKpi(index) {
            if(confirm('¿Eliminar este indicador?')) {
                const kpi = currentKpiProject.kpis[index];
                // Optimistic UI update
                currentKpiProject.kpis.splice(index, 1);
                // Adjust active index
                if(index <= activeKpiIndex) activeKpiIndex = Math.max(0, activeKpiIndex - 1);
                if(currentKpiProject.kpis.length === 0) createNewKpi(); // Ensure at least one
                else renderKpiModalContent();
                
                // Call backend
                deleteKpiAsync(kpi);
            }
        }
        
        async function deleteKpiAsync(kpi) {
             try { await fetch(APPS_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'deleteKpiData', payload: { id: kpi.id, proyecto: currentKpiProject.nombre } }) }); showToast('KPI eliminado', 'success'); } catch(e) { console.error(e); }
        }
        
        function createNewKpi() {
            currentKpiProject.kpis.push({ id: 'new_' + Date.now() + Math.random().toString(36).substr(2, 5), objetivo: '', l_base: '', meta: '', indicador: '', numerador: '', denominador: '', monthly: {} });
            activeKpiIndex = currentKpiProject.kpis.length - 1; renderKpiModalContent();
        }

        // Helper to update KPI data on input
        function updateKpiField(field, value) {
            if (!currentKpiProject || !currentKpiProject.kpis[activeKpiIndex]) return;
            const kpi = currentKpiProject.kpis[activeKpiIndex];
            kpi[field] = value;
            if (field === 'objetivo') renderKpiList(); // Update sidebar title live
        }

        function updateKpiMonth(month, value) {
            if (!currentKpiProject || !currentKpiProject.kpis[activeKpiIndex]) return;
            const kpi = currentKpiProject.kpis[activeKpiIndex];
            if(!kpi.monthly) kpi.monthly = {};
            kpi.monthly[month] = value;
        }

        function renderKpiForm() {
            const kpi = currentKpiProject.kpis[activeKpiIndex];
            const monthly = kpi.monthly || {};
            const container = document.getElementById('kpiFormContainer');
            const months = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];
            
            let fieldsHTML = `
                <div class="mb-6 grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Objetivo</label>
                        <input class="w-full border border-slate-300 rounded p-2 text-sm" value="${kpi.objetivo || ''}" placeholder="Ej: Reducir costos..." oninput="updateKpiField('objetivo', this.value)">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Indicador</label>
                        <input class="w-full border border-slate-300 rounded p-2 text-sm" value="${kpi.indicador || ''}" placeholder="Ej: % Defectos" oninput="updateKpiField('indicador', this.value)">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Línea Base</label>
                        <input class="w-full border border-slate-300 rounded p-2 text-sm" value="${kpi.l_base || ''}" placeholder="Valor base inicial" oninput="updateKpiField('l_base', this.value)">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Meta</label>
                        <input class="w-full border border-slate-300 rounded p-2 text-sm" value="${kpi.meta || ''}" placeholder="Valor objetivo" oninput="updateKpiField('meta', this.value)">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Numerador</label>
                        <input class="w-full border border-slate-300 rounded p-2 text-sm" value="${kpi.numerador || ''}" oninput="updateKpiField('numerador', this.value)">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Denominador</label>
                        <input class="w-full border border-slate-300 rounded p-2 text-sm" value="${kpi.denominador || ''}" oninput="updateKpiField('denominador', this.value)">
                    </div>
                </div>
            `;
            
            let tableHTML = `
                <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden overflow-x-auto">
                    <table class="kpi-table w-full">
                        <thead>
                            <tr><th class="text-left w-32 bg-slate-100">MES</th>${months.map(m => `<th>${m}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="font-bold bg-slate-50 text-left pl-3">Valor</td>
                                ${months.map(m => `<td class="p-0"><input class="text-center w-full h-full py-2 hover:bg-slate-50" data-month="${m.toLowerCase()}" value="${monthly[m.toLowerCase()] || ''}" placeholder="-" oninput="updateKpiMonth('${m.toLowerCase()}', this.value)"></td>`).join('')}
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = fieldsHTML + tableHTML;
        }

        async function saveCurrentKpi() {
            const kpi = currentKpiProject.kpis[activeKpiIndex];
            const kpiPayload = { proyecto: currentKpiProject.nombre, id: kpi.id, objetivo: kpi.objetivo, l_base: kpi.l_base, meta: kpi.meta, indicador: kpi.indicador, numerador: kpi.numerador, denominador: kpi.denominador, datos_mensuales: kpi.monthly };
            try { showToast('Guardando KPI...', 'info'); const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'saveKpiData', payload: kpiPayload }) });
                const result = await response.json(); console.log('KPI Saved:', result); showToast('KPI guardado', 'success'); renderKpiList();
            } catch(e) { console.error(e); showToast('Error al guardar KPI', 'error'); }
        }

        // ========= LOAD DATA =========
        
        // Actualizar el timestamp visible en el UI
        function updateLastUpdateTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timeStr = `${hours}:${minutes}:${seconds}`;
            lastUpdateTime = timeStr;
            document.getElementById('lastUpdateTime').textContent = `Última actualización: ${timeStr}`;
        }
        
        // Refrescar datos manualmente
        async function refreshDataManual() {
            if (isLoadingData) return; // Evitar múltiples clicks
            
            const btn = document.getElementById('btn-refresh');
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('refresh-spinning');
            btn.disabled = true;
            
            showToast('Refrescando datos...', 'info');
            await loadDataFromSheet();
            
            updateLastUpdateTime();
            icon.classList.remove('refresh-spinning');
            btn.disabled = false;
            showToast('Datos actualizados', 'success');
        }
        
        // Inicializar auto-refresh cada 5 minutos
        function initAutoRefresh() {
            // Actualizar time display inmediatamente
            updateLastUpdateTime();
            
            // Auto-refresh cada 5 minutos
            if (autoRefreshTimerId) clearInterval(autoRefreshTimerId);
            autoRefreshTimerId = setInterval(async () => {
                console.log('Auto-refreshing datos...');
                await loadDataFromSheet();
                updateLastUpdateTime();
            }, AUTO_REFRESH_INTERVAL);
        }
        
        // ========= LOAD DATA =========
        async function loadDataFromSheet() {
            isLoadingData = true;
            try {
                console.log('Cargando datos...');
                const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'fetchAllData' }) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                if (text.trim().startsWith('<')) throw new Error('Recibí HTML (Login Page). Revisa permisos "Cualquier persona".');
                const result = JSON.parse(text);
                
                if (result.datosData) {
                    projectData = transformSheetDataToGantt(result.datosData, result.kpiData);
                    // Ensure all projects start collapsed by default
                    projectData.forEach(p => p.expanded = false);
                    updateProjectMap();
                    showToast('Datos cargados', 'success');
                } else { projectData = []; } 
                populateFilterOptions(); render();
            } catch (e) {
                console.error('Error cargando:', e);
                // Demo fallback
                const DEMO = [{ id: 'p1', area: 'HILANDERIA', tipo: 'Digital', prioridad: 'Alta', inicio: '14/01/2026', nombre: 'Digitalización y sistematización', ejecutor: 'EO', gestor: 'JP', expanded: false, status: 2, gantt: padGantt([]), kpis: [], tasks: [] }];
                projectData = DEMO; 
                updateProjectMap();
                render();
                showToast(`Error: ${e.message}`, 'error');
            } finally {
                isLoadingData = false;
            }
        }

        function transformSheetDataToGantt(datosData, kpiData) {
            const proyectosMap = new Map();
            const kpiMap = new Map(); 
            
            // Mapeo de KPIs por proyecto
            if (kpiData) {
                kpiData.forEach(k => {
                    const pname = k['PROYECTO'];
                    if(pname && String(pname).trim()) {
                        if(!kpiMap.has(pname)) kpiMap.set(pname, []);
                        kpiMap.get(pname).push({
                            id: k['ID'] || ('k_' + Math.random().toString(36).substr(2, 5)),
                            objetivo: k['OBJETIVO'], l_base: k['L_BASE'], meta: k['META'], indicador: k['INDICADOR'], denominador: k['DENOMINADOR'], numerador: k['NUMERADOR'],
                            monthly: { ene: k['ENE'], feb: k['FEB'], mar: k['MAR'], abr: k['ABR'], may: k['MAY'], jun: k['JUN'], jul: k['JUL'], ago: k['AGO'], sep: k['SEP'], oct: k['OCT'], nov: k['NOV'], dic: k['DIC'] }
                        });
                    }
                });
            }
            
            // Procesar datos de Datos sheet
            datosData.forEach(row => {
                const projName = row['PROYECTO'] || ''; 
                const taskName = row['TAREA'] || '';
                
                // Validar que proyecto tenga nombre
                if (!String(projName).trim()) return;
                
                // Crear proyecto solo si no existe (usar primer registro como referencia)
                if (!proyectosMap.has(projName)) {
                    proyectosMap.set(projName, {
                        id: 'p_' + projName.replace(/\s+/g, '_').toLowerCase(), 
                        area: row['AREA'] || '', 
                        tipo: row['TIPO'] || 'Proceso', 
                        prioridad: row['PRIORIDAD'] || '', 
                        inicio: row['F.INICIO'] && String(row['F.INICIO']).trim() !== '' ? row['F.INICIO'] : getTodayFormatted(),
                        nombre: projName, 
                        ejecutor: '', // Los proyectos NO tienen ejecutor directo (es para tareas)
                        gestor: row['GESTOR'] || '', 
                        expanded: false, 
                        status: getStatusFromText(row['ESTADO'] || ''), 
                        gantt: padGantt([]), 
                        kpis: kpiMap.get(projName) || [], 
                        tasks: []
                    });
                }
                
                // Agregar tarea si existe nombre de tarea
                if (String(taskName).trim()) {
                    let taskGantt = padGantt([]);
                    
                    // Calcular rango gantt desde F.INICIO y F. FIN
                    if(row['F.INICIO'] && row['F. FIN']) {
                        const startW = dateToWeekIndex(row['F.INICIO']); 
                        const endW = parseInt(row['F. FIN'], 10) - 1;
                        
                        if(startW >= 0 && endW >= startW && startW < MAX_YEAR_WEEKS) { 
                            for(let i = startW; i <= Math.min(MAX_YEAR_WEEKS - 1, endW); i++) { 
                                taskGantt[i] = 1; 
                            } 
                        }
                    }
                    
                    // Crear objeto tarea
                    const proyecto = proyectosMap.get(projName);
                    proyecto.tasks.push({
                        id: 't_' + projName.replace(/\s+/g, '_') + '_' + taskName.replace(/\s+/g, '_') + '_' + Math.random().toString(36).substr(2, 5),
                        nombre: taskName, 
                        tipo: row['TIPO'] || 'Proceso', 
                        prioridad: row['PRIORIDAD'] || '', 
                        ejecutor: row['EJECUTOR'] || '', 
                        inicio: row['F.INICIO'] && String(row['F.INICIO']).trim() !== '' ? row['F.INICIO'] : getTodayFormatted(), 
                        status: getStatusFromText(row['ESTADO'] || ''), 
                        gantt: taskGantt
                    });
                }
            });
            
            // Recalcular gantt del proyecto basado en tareas
            const projs = Array.from(proyectosMap.values());
            projs.forEach(p => { 
                const pGantt = new Array(MAX_YEAR_WEEKS).fill(0); 
                
                // El gantt del proyecto es la unión de todos los gantts de las tareas
                p.tasks.forEach(t => { 
                    t.gantt.forEach((v, i) => {
                        if(v > 0) pGantt[i] = 1;
                    });
                }); 
                
                p.gantt = pGantt;
                
                // Recalcular estado del proyecto basado en tareas
                p.status = calculateProjectStatus(p.tasks);
                
                // Recalcular tipo del proyecto basado en tareas
                p.tipo = calculateProjectType(p.tasks);
            });
            
            return projs;
        }

        window.addEventListener('resize', syncRowHeights);
        // Start app
        (async () => {
            await loadDataFromSheet();
            // Extraer columnas inmediatamente después de cargar datos
            refreshCachedColumns();
            initAutoRefresh();
        })();
    </script>
</body>
</html>
