
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAPA DE PROYECTOS CON AVANCE</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style id="gantt-embedded-styles">
        /* Gantt embedded styles (from gantt.html) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        .gantt-grid { display: grid; grid-template-columns: 40px 140px 100px 100px 200px 200px 100px 120px repeat(13, 1fr); min-width: 1200px; background-color: white; border: 1px solid #e2e8f0; }
        .sticky-1 { position: sticky; left: 0; z-index: 50; background: inherit; border-right: 1px solid #e2e8f0; }
        .sticky-2 { position: sticky; left: 40px; z-index: 49; background: inherit; border-right: 1px solid #e2e8f0; }
        .header-cell { background-color: #0f172a; color: white; padding: 12px 8px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; text-align: center; border: 1px solid #1e293b; display: flex; align-items: center; justify-content: center; }
        .data-cell { padding: 12px 10px; border: 1px solid #e2e8f0; font-size: 0.85rem; min-height: 55px; display: flex; align-items: center; background-color: white; }
        .project-row-bg { background-color: #f8fafc; font-weight: 700; }
        .task-row-bg { background-color: white; }
        .gantt-block { height: 24px; background-color: #2563eb; border-radius: 4px; width: 80%; margin: auto; }
        .gantt-dot { height: 8px; width: 8px; background-color: #cbd5e1; border-radius: 50%; margin: auto; }
        .gantt-master-part { height: 28px; background: linear-gradient(90deg,#0ea5e9,#2563eb); border-radius: 2px; margin: 6px auto; width: 90%; box-shadow: 0 1px 0 rgba(255,255,255,0.08) inset; }
        .gantt-master-start { border-top-left-radius: 6px; border-bottom-left-radius: 6px; }
        .gantt-master-end { border-top-right-radius: 6px; border-bottom-right-radius: 6px; }
        .gantt-master-label { color: white; font-weight: 600; font-size: 12px; text-align: center; line-height: 28px; }
        .week-cell { height: 46px; display:flex; align-items:center; justify-content:center; cursor:pointer; user-select: none; color: transparent; }
        .week-cell:hover { background-color: #f1f5f9; }
        .week-on { background-color: transparent; }
        .week-on .gantt-block { width: 90%; }
        /* Stable indicator for painted week: exists always, toggling only class to avoid DOM reflow */
        .gantt-block-indicator { height: 24px; width: 80%; border-radius: 4px; background: transparent; transition: background 0.12s ease, opacity 0.12s ease; pointer-events: none; display:block; }
        .gantt-block-indicator.on { background: linear-gradient(90deg,#60a5fa,#2563eb); }
        /* when a week cell is painted, color the cell background (not text) */
        .week-cell.on { background: linear-gradient(90deg,#60a5fa,#2563eb); }
        .week-cell.on .gantt-block-indicator { background: transparent; }
        /* Master container variant: always present, toggle classes instead of replacing innerHTML */
        .gantt-master-container { height: 28px; display:flex; align-items:center; justify-content:center; }
        .gantt-master-inner { height: 28px; width: 90%; border-radius: 2px; display:flex; align-items:center; justify-content:center; transition: background 0.12s ease; background: transparent; }
        .gantt-master-inner.on { background: linear-gradient(90deg,#0ea5e9,#2563eb); }
        .gantt-master-inner.start { border-top-left-radius: 6px; border-bottom-left-radius: 6px; }
        .gantt-master-inner.end { border-top-right-radius: 6px; border-bottom-right-radius: 6px; }
        .gantt-master-label { color: white; font-weight: 600; font-size: 12px; text-align: center; line-height: 28px; opacity: 1; transition: opacity 0.12s ease; pointer-events: none; }
        .gantt-master-label.hidden { opacity: 0; }
        /* Status select styles */
        .status-select { padding: 4px 6px; border-radius: 6px; border: 1px solid #cbd5e1; font-weight: 700; font-size: 12px; background: transparent; color: #0f172a; }
        .status-select.status-en-proceso { background: linear-gradient(90deg,#60a5fa,#2563eb); color: #fff; border-color: rgba(37,99,235,0.6); }
        .status-select.status-terminado { background: linear-gradient(90deg,#86efac,#16a34a); color: #06361a; border-color: rgba(16,185,129,0.6); }
        .status-select.status-pendiente { background: #f1f5f9; color: #475569; border-color: #cbd5e1; }
        .truncate-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        /* viewport used to scale/fit the gantt grid into available width */
        .gantt-viewport { width: 100%; overflow: auto; }
        .gantt-grid { transform-origin: top left; }
    </style>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 10px;
            background: #f8f9fa;
            display: flex;
            justify-content: center;
        }

        .main-layout-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 1600px;
            padding: 10px;
            box-sizing: border-box;
        }

        .top-row {
            display: flex;
            flex-direction: row;
            gap: 15px;
            align-items: flex-start;
            width: 100%;
        }

        .strategic-column { flex: 1 1 15%; }

        .main-column {
            flex: 1 1 85%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .main-column > .process-section-box {
            display: flex;
            flex-direction: column;
        }

        .support-section { width: 100%; }

        .section-title {
            font-weight: bold;
            font-size: 16px;
            margin-top: 15px;
            margin-bottom: 8px;
            text-align: center;
            color: #343a40;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .process-map {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 10px;
            width: 100%;
            justify-content: center;
        }

        .base-step {
            padding: 8px 10px;
            border-radius: 6px;
            text-align: center;
            position: relative;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            font-weight: bold;
            font-size: 10px;
            white-space: normal;
            border: 1px solid;
            text-transform: uppercase;
            min-width: 80px;
            min-height: 40px;
            flex: 1;
            box-sizing: border-box;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .base-step:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .step-strategic-color { background-color: #003366; color: #ffffff; border-color: #002244; }
        .step-principal-container-color { background-color: #0056b3; color: #ffffff; border-color: #004085; }
        .step-quality-color { background-color: #6c757d; color: #ffffff; border-color: #5a6268; }
        .step-support-color { background-color: #d1e7dd; color: #0f5132; border-color: #badbcc; font-weight: normal; }
        .step-default-color { background-color: #e9ecef; color: #495057; border-color: #ced4da; }
        .sub-step-color { background-color: #d4edda; color: #1a472a; border-color: #c3e6cb; }

        .sub-step {
            min-width: 50px;
            padding: 4px 8px;
            font-size: 9px;
            margin: 2px;
            border: 1px solid rgba(0,0,0,0.1);
            flex: 1;
            position: relative;
            box-sizing: border-box;
            box-shadow: none;
        }

        .sub-step:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .sub-step-long-label { min-width: 100px; padding: 6px 10px; font-size: 9px; }
        .base-step-long-label { min-width: 120px; padding: 6px 10px; font-size: 9px; }

        .step-container-general {
            min-width: 150px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            flex: 1;
            position: relative;
            box-sizing: border-box;
            overflow: hidden;
        }

        .step-container-general .container-title {
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 4px;
            text-transform: uppercase;
            color: #ffffff;
            z-index: 1;
        }

        .step-container-general .sub-steps-wrapper {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 4px;
            width: 100%;
            z-index: 1;
        }

        #planeamiento .sub-steps-wrapper {
            flex-direction: column;
            align-items: stretch;
            gap: 6px;
        }

        .arrow {
            font-size: 20px;
            color: #6c757d;
            margin: 0 8px;
            flex-shrink: 0;
        }

        .process-section-box {
            background-color: #ffffff;
            border: 1px dashed #adb5bd;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            width: 100%;
            box-sizing: border-box;
        }

        .main-flow-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }

        .main-flow-row {
            display: flex;
            flex-direction: row;
            align-items: stretch;
            gap: 8px;
            width: 100%;
        }

        .main-flow-row .arrow { display: flex; align-items: center; }
        .main-flow-row > .base-step { flex: 1 1 15%; }
        .main-flow-row > .step-container-general { flex: 1 1 60%; }

        .vertical-connector {
            width: 3px;
            height: 20px;
            background-color: #adb5bd;
            margin: auto;
        }

        .progress-bar-container {
            width: calc(100% - 16px);
            height: 6px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background-color: #28a745;
            border-radius: 3px;
            transition: width 0.5s ease-in-out;
        }

        .progress-percentage {
            font-size: 9px;
            font-weight: bold;
            color: inherit;
            margin-top: 2px;
            display: block;
            white-space: nowrap;
        }

        .category-progress-percentage {
            font-size: 14px;
            font-weight: bold;
            margin-left: 8px;
            color: #007bff;
        }

        .base-step > span:first-child:not(.progress-percentage),
        .step-container-general .container-title {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .strategic-column .process-map {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 6px;
        }

        .strategic-column .base-step {
            flex-grow: 0;
            width: 100%;
            min-height: 30px;
            padding-top: 6px;
            padding-bottom: 6px;
            font-size: 9px;
        }

        .strategic-column .progress-bar-container { height: 5px; margin-top: 4px; }
        .strategic-column .progress-percentage { font-size: 8px; margin-top: 1px; }

        .strategic-column #planeamiento .container-title { font-size: 10px; }

        .strategic-column .process-section-box {
            height: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        /* ===== RESUMEN + BOTONES ===== */
        #summary-box {
            background-color: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            border: 1px dashed #adb5bd;
            box-sizing: border-box;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: 16px;
            flex-wrap: wrap;
            width: 100%;
        }

        #summary-total-count {
            font-size: 16px;
            font-weight: bold;
            color: #343a40;
        }

        .summary-divider {
            border-left: 1px solid #ced4da;
            height: 24px;
        }

        .summary-divider-double {
            border-left: 3px double #adb5bd;
            height: 24px;
            margin-left: 8px;
        }

        .summary-status-block { font-size: 14px; font-weight: 600; }

        .summary-hours-block {
            font-size: 16px;
            font-weight: bold;
            color: #343a40;
        }

        .summary-hours-actual {
            color: #007bff;
            cursor: help;
        }

        .summary-hours-proy {
            color: #fd7e14;
            cursor: help;
        }

        .summary-status-terminado { color: #007bff; }
        .summary-status-en-proceso { color: #fd7e14; }
        .summary-status-estacionamiento { color: #b22222; }

        .summary-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        #kanban-button,
        #informe-button,
        #gantt-button,
        #acambio-button {
            padding: 5px 10px;
            font-size: 12px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        #kanban-button {
            background-color: #fd7e14;
            color: white;
        }

        #kanban-button:hover {
            background-color: #e66a00;
            transform: translateY(-1px);
        }

        #informe-button {
            background-color: #A3E635;
            color: #064e3b;
        }

        #informe-button:hover {
            filter: brightness(0.95);
            transform: translateY(-1px);
        }

        #gantt-button {
            background-color: #0d6efd;
            color: white;
        }

        #gantt-button:hover {
            background-color: #0b5ed7;
            transform: translateY(-1px);
        }

        #acambio-button {
            background-color: #14b8a6;
            color: #f0fdfa;
        }

        #acambio-button:hover {
            background-color: #0f9f90;
            transform: translateY(-1px);
        }

        /* Banner de error */
        #error-banner {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: #fee2e2;
            color: #991b1b;
            border-bottom: 1px solid #fecaca;
            padding: 10px 16px;
            font-size: 14px;
            display: none;
            z-index: 3000;
            text-align: center;
        }

        /* Overlay de Cargando */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            z-index: 2500;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #0d6efd;
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- ESTILOS MODALES GENERALES --- */
        #details-modal,
        #informe-modal,
        #acambio-modal {
            display: none;
            position: fixed;
            z-index: 4000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px 25px;
            border: 1px solid #888;
            border-radius: 8px;
            width: 80%;
            max-width: 900px;
            max-height: 85vh;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        }

        #informe-modal .modal-content {
            width: 80%;
            max-width: 1000px;
        }

        #acambio-modal .modal-content {
            width: 92%;
            max-width: 1280px;
        }

        .modal-close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: #000;
            text-decoration: none;
        }

        #modal-title,
        #informe-modal-title,
        #acambio-modal-title {
            margin-top: 0;
            color: #003366;
            font-family: 'Inter', sans-serif;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            font-size: 1.2em;
        }

        .modal-title-stats {
            color: #007bff;
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 15px;
        }

        .modal-table-wrapper {
            max-height: 450px;
            overflow-y: auto;
            margin-top: 15px;
            flex: 1;
            overflow-x: hidden;
        }

        #informe-modal .modal-table-wrapper {
            max-height: calc(85vh - 120px);
        }

        .modal-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .modal-table th,
        .modal-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            white-space: normal;
            word-break: break-word;
        }

        .modal-table th {
            background-color: #f2f2f2;
            text-transform: uppercase;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            position: sticky;
            top: 0;
        }

        .modal-table tr:nth-child(even) { background-color: #f9f9f9; }

        .status-terminado {
            background-color: #d4edda;
            color: #155724;
        }

        .status-en-proceso {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-estacionamiento {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* === BLOQUES DEL INFORME === */
        .informe-wrapper {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-right: 8px;
        }

        .informe-project-block {
            border: 1px solid #d0d7de;
            border-radius: 6px;
            overflow: visible;
            background: #ffffff;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
            page-break-inside: avoid;
            height: auto;
            min-height: fit-content;
        }

        .informe-project-header {
            padding: 8px 16px;
            background: #e3f2fd;
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            color: #0b3b71;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            /* make project header sticky within the scrollable wrapper */
            position: sticky;
            top: 0;
            z-index: 25;
            height: 44px;
            box-shadow: inset 0 -1px 0 rgba(0,0,0,0.04);
        }

        .informe-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            table-layout: fixed;
            height: auto;
        }

        .informe-table th,
        .informe-table td {
            padding: 8px 10px;
            border: 1px solid #e1e4e8;
            text-align: left;
            white-space: normal;
            word-break: break-word;
            overflow-wrap: break-word;
            vertical-align: top;
            height: auto;
            min-height: 35px;
        }

        .informe-table thead th {
            background: #c6f6d5;
            color: #1a4731;
            font-weight: 700;
            text-transform: uppercase;
            position: sticky;
            /* place table header right below the project header */
            top: 44px;
            z-index: 20;
            text-align: center;
            vertical-align: middle;
            padding-top: 12px;
            padding-bottom: 12px;
        }

        .informe-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        /* --- ESTADO (viñetas) --- */
        .estado-bullet {
            display: inline-block;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            line-height: 18px;
            text-align: center;
            font-size: 12px;
            color: #ffffff;
            font-weight: 700;
        }

        .estado-terminado { background: #28a745; }
        .estado-en-proceso { background: #ffc107; color: #3a2d00; }
        .estado-estacionamiento { background: #dc3545; }

        /* --- LEYENDA (en modal informe, esquina superior derecha) --- */
        .informe-legend {
            position: absolute;
            /* header will now control positioning; keep inline styles for internal layout */
            position: static;
            display: flex;
            gap: 14px;
            align-items: center;
            font-size: 13px;
            color: #0b3b71;
            white-space: nowrap;
            z-index: 30;
            font-weight: 600;
        }

        .informe-legend .legend-item { display:flex; gap:8px; align-items:center; }
        .informe-legend .legend-bullet-small { width:12px; height:12px; border-radius:50%; display:inline-block; }
        .informe-legend .legend-bullet-check { width:14px; height:14px; display:inline-flex; align-items:center; justify-content:center; border-radius:50%; color:#fff; font-weight:700; }
        .informe-legend .legend-text { font-size:13px; color:#0b3b71; }

        .legend-terminado { background:#28a745; }
        .legend-en-proceso { background:#ffc107; color:#3a2d00; }
        .legend-estacionamiento { background:#dc3545; }

        /* Toggle switch styles */
        .toggle-switch {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            vertical-align: middle;
            margin-right: 12px;
            z-index: 40;
            transform: scale(0.7);
            transform-origin: right center;
        }
        .toggle-switch input { display: none; }
        .toggle-slider {
            width: 64px;
            height: 34px;
            background: #d6eefe;
            border-radius: 22px;
            position: relative;
            box-shadow: inset 0 0 0 1px rgba(30,144,255,0.35);
            cursor: pointer;
            border: 1px solid rgba(30,144,255,0.25);
        }
        .toggle-slider::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 26px;
            height: 26px;
            background: #fff;
            border-radius: 50%;
            transition: left 0.18s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.12);
        }
        .toggle-switch input:checked + .toggle-slider {
            background: #b0b0b0;
        }
        .toggle-switch input:checked + .toggle-slider::after {
            left: 34px;
        }
        .toggle-label {
            font-size: 13px;
            color: #0b3b71;
            font-weight:600;
            white-space:nowrap;
        }

        /* Header layout for modal title + legend + switch on one line */
        .informe-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding-right: 18px;
        }
        .informe-header #informe-modal-title { margin: 0; }
        .informe-controls { display:flex; align-items:center; gap:12px; }

        /* Modal background when filter active (darker) */
        #informe-modal.filter-active .modal-content {
            background-color: #939393; /* ~40% darker than #f5f5f5 */
        }

        /* --- BARRA DE AVANCE DENTRO DE LA CELDA %AVANCE --- */
        .avance-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        .avance-bar-container {
            flex: 1 1 auto;
            background: #e9f5ff; /* fondo claro */
            border-radius: 6px;
            height: 18px;
            overflow: hidden;
            position: relative;
        }

        .avance-bar-fill {
            height: 100%;
            background: linear-gradient(90deg,#cfe9ff,#7ec1ff);
            width: 0%;
            transition: width 0.6s ease;
        }

        .avance-label {
            min-width: 36px;
            text-align: right;
            font-weight: 600;
            font-size: 12px;
            color: #064b8a;
        }

        .acambio-wrapper {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-right: 8px;
        }

        .acambio-kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 10px;
        }

        .acambio-kpi-card {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: #f8fafc;
            padding: 10px 12px;
        }

        .acambio-kpi-title {
            color: #0f766e;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.04em;
            margin-bottom: 6px;
        }

        .acambio-kpi-value {
            color: #0f172a;
            font-size: 20px;
            font-weight: 700;
            line-height: 1.15;
        }

        .acambio-kpi-sub {
            color: #475569;
            font-size: 12px;
            margin-top: 4px;
        }

        .acambio-top-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 10px;
        }

        .acambio-top-card {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: #ffffff;
            padding: 10px 12px;
        }

        .acambio-top-title {
            color: #0f172a;
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .acambio-top-list {
            margin: 0;
            padding: 0;
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .acambio-top-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            border-bottom: 1px dashed #e2e8f0;
            padding-bottom: 5px;
            font-size: 12px;
        }

        .acambio-top-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .acambio-top-label {
            color: #0f172a;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 70%;
        }

        .acambio-top-value {
            color: #0f766e;
            font-weight: 700;
            white-space: nowrap;
        }

        .acambio-link-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #99f6e4;
            background: #ecfeff;
            color: #0f766e;
            font-size: 11px;
            font-weight: 700;
            text-decoration: none;
            white-space: nowrap;
        }

        .acambio-link-btn:hover {
            background: #ccfbf1;
            border-color: #5eead4;
        }

        /* --- MODAL KANBAN --- */
        #kanban-modal {
            display: none;
            position: fixed;
            z-index: 5000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }

        /* Gantt modal shares kanban-content styling but needs its own overlay id */
        #gantt-modal {
            display: none;
            position: fixed;
            z-index: 5000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }

        .kanban-content {
            background-color: #fefefe;
            margin: 3% auto;
            padding: 20px 25px;
            border-radius: 8px;
            width: 90%;
            max-width: 1200px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        #kanban-modal .modal-close {
            top: 15px;
            right: 25px;
        }

        .kanban-board {
            display: flex;
            gap: 15px;
            justify-content: space-between;
            min-height: 500px;
            margin-top: 15px;
        }

        .kanban-column {
            flex: 1;
            background-color: #e9ecef;
            border-radius: 5px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-content: flex-start;
            max-height: 60vh;
            overflow-y: auto;
        }

        .kanban-column h3 {
            text-align: center;
            margin-top: 5px;
            margin-bottom: 10px;
            color: #495057;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            font-size: 14px;
            border-bottom: 2px solid #ced4da;
            padding-bottom: 5px;
            position: sticky;
            top: -10px;
            background-color: #e9ecef;
            z-index: 10;
            width: 100%;
            order: -1;
        }

        .kanban-card {
            background-color: white;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-size: 11px;
            cursor: grab;
            width: calc(50% - 4px);
            box-sizing: border-box;
        }

        .kanban-card .card-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 12px;
            color: #333;
            overflow-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
        }

        .kanban-card .card-detail {
            color: #555;
            margin-bottom: 3px;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .kanban-card.color-1 { border-left: 4px solid #6f42c1; }
        .kanban-card.color-2 { border-left: 4px solid #20c997; }
        .kanban-card.color-3 { border-left: 4px solid #fd7e14; }
        .kanban-card.color-4 { border-left: 4px solid #0dcaf0; }
        .kanban-card.color-5 { border-left: 4px solid #ffc107; }

        /* RESPONSIVE */
        @media (max-width: 992px) {
            .top-row { flex-direction: column; }
            .strategic-column, .main-column { width: 100%; }
        }

        @media (max-width: 768px) {
            .main-flow-row {
                flex-direction: column;
                align-items: stretch;
            }

            .main-flow-row .arrow {
                margin: 8px auto;
                transform: rotate(90deg);
            }

            .base-step,
            .sub-step,
            .base-step-long-label,
            .sub-step-long-label {
                font-size: 9px;
                min-height: 30px;
            }

            .section-title { font-size: 14px; }
            .step-container-general .container-title { font-size: 10px; }
            .progress-bar-container { width: calc(100% - 10px); }

            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 15px;
            }

            .modal-table { font-size: 11px; }

            #modal-title,
            #informe-modal-title { font-size: 1.1em; }

            .modal-title-stats {
                display: block;
                margin-left: 0;
                margin-top: 5px;
                font-size: 0.85em;
            }

            .kanban-content {
                width: 95%;
                margin: 5% auto;
                padding: 15px;
            }

            .kanban-board {
                flex-direction: column;
                min-height: auto;
                gap: 20px;
            }

            .kanban-column { max-height: 300px; }

            .summary-actions {
                width: 100%;
                justify-content: flex-end;
                margin-left: 0;
            }

            .informe-project-header { font-size: 12px; }
            .informe-table { font-size: 11px; }
        }
    </style>
</head>
<body>

<div id="error-banner" role="alert" aria-live="assertive"></div>
<div id="loading-overlay" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <div style="font-weight:600;color:#0d6efd;">Cargando datos…</div>
</div>

<div class="main-layout-container">

    <div class="top-row">
        <div class="process-section-box strategic-column">
            <div class="section-title">
                PROCESOS ESTRATEGICOS
                <span class="category-progress-percentage" id="strategicCategoryPercentage"></span>
            </div>
            <div class="process-map">
                <a href="#" target="_blank" class="base-step step-strategic-color" id="altaDireccion">
                    <span>ALTA DIRECCION</span>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="altaDireccionFill"></div>
                    </div>
                    <span class="progress-percentage" id="altaDireccionPercentage"></span>
                </a>
                <a href="#" target="_blank" class="base-step step-strategic-color" id="sostenibilidad">
                    <span>SOSTENIBILIDAD</span>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="sostenibilidadFill"></div>
                    </div>
                    <span class="progress-percentage" id="sostenibilidadPercentage"></span>
                </a>
                <div class="base-step step-container-general step-strategic-color" id="planeamiento">
                    <span class="container-title">PLANEAMIENTO</span>
                    <div class="sub-steps-wrapper">
                        <a href="#" target="_blank" class="base-step sub-step sub-step-color" id="pcpTextil">
                            <span>PCP TEXTIL</span>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="pcpTextilFill"></div>
                            </div>
                            <span class="progress-percentage" id="pcpTextilPercentage"></span>
                        </a>
                        <a href="#" target="_blank" class="base-step sub-step sub-step-color" id="pcpConfecciones">
                            <span>PCP CONFECCIONES</span>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="pcpConfeccionesFill"></div>
                            </div>
                            <span class="progress-percentage" id="pcpConfeccionesPercentage"></span>
                        </a>
                    </div>
                    <div class="progress-bar-container" style="margin-top: 10px;">
                        <div class="progress-bar-fill" id="planeamientoFill"></div>
                    </div>
                    <span class="progress-percentage" id="planeamientoPercentage"></span>
                </div>
                <a href="#" target="_blank" class="base-step step-strategic-color" id="comercial">
                    <span>COMERCIAL</span>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" id="comercialFill"></div>
                    </div>
                    <span class="progress-percentage" id="comercialPercentage"></span>
                </a>
            </div>
        </div>

        <div class="main-column">

            <div id="summary-box">
                <div id="summary-total-count" class="summary-total-block">Total 0</div>
                <div class="summary-divider"></div>
                <div id="summary-terminado" class="summary-status-block summary-status-terminado">
                    Terminado 0% [0]
                </div>
                <div id="summary-en-proceso" class="summary-status-block summary-status-en-proceso">
                    En proceso 0% [0]
                </div>
                <div id="summary-estacionamiento" class="summary-status-block summary-status-estacionamiento">
                    Estacionamiento 0% [0]
                </div>
                <div class="summary-divider-double"></div>
                <div class="summary-hours-block">
                    [<span id="summary-hours-actual" class="summary-hours-actual" title="0.0 personas">0.0 hrs actual</span>
                    -
                    <span id="summary-hours-proy" class="summary-hours-proy" title="0.0 personas">0 hrs proy/año</span>]
                </div>

                <div class="summary-actions">
                    <button id="gantt-button">Gantt</button>
                    <button id="kanban-button">Kanban</button>
                    <button id="acambio-button">A.cambio</button>
                </div>
            </div>

            <div class="process-section-box">
                <div class="section-title">
                    PROCESOS PRINCIPALES
                    <span class="category-progress-percentage" id="principalesCategoryPercentage"></span>
                </div>
                <div class="process-map">
                    <div class="main-flow-container">
                        <div class="main-flow-row">
                            <a href="#" target="_blank" class="base-step step-strategic-color" id="desarrolloTextil">
                                <span>DESARROLLO TEXTIL</span>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" id="desarrolloTextilFill"></div>
                                </div>
                                <span class="progress-percentage" id="desarrolloTextilPercentage"></span>
                            </a>
                            <span class="arrow">&rarr;</span>
                            <div class="base-step step-container-general step-principal-container-color" id="pTextiles">
                                <span class="container-title">TEXTIL</span>
                                <div class="sub-steps-wrapper">
                                    <a href="#" target="_blank" class="base-step step-default-color" id="hilanderia">
                                        <span>HILANDERIA</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar-fill" id="hilanderiaFill"></div>
                                        </div>
                                        <span class="progress-percentage" id="hilanderiaPercentage"></span>
                                    </a>
                                    <a href="#" target="_blank" class="base-step step-default-color" id="tejeduria">
                                        <span>TEJEDURIA</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar-fill" id="tejeduriaFill"></div>
                                        </div>
                                        <span class="progress-percentage" id="tejeduriaPercentage"></span>
                                    </a>
                                    <a href="#" target="_blank" class="base-step step-default-color" id="tintoreria">
                                        <span>TINTORERIA</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar-fill" id="tintoreriaFill"></div>
                                        </div>
                                        <span class="progress-percentage" id="tintoreriaPercentage"></span>
                                    </a>
                                    <a href="#" target="_blank" class="base-step step-default-color" id="lavanderia">
                                        <span>LAVANDERIA</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar-fill" id="lavanderiaFill"></div>
                                        </div>
                                        <span class="progress-percentage" id="lavanderiaPercentage"></span>
                                    </a>
                                    <a href="#" target="_blank" class="base-step step-default-color" id="estampado">
                                        <span>ESTAMPADO</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar-fill" id="estampadoFill"></div>
                                        </div>
                                        <span class="progress-percentage" id="estampadoPercentage"></span>
                                    </a>
                                </div>
                                <div class="progress-bar-container" style="margin-top: 10px;">
                                    <div class="progress-bar-fill" id="pTextilesFill"></div>
                                </div>
                                <span class="progress-percentage" id="pTextilesPercentage"></span>
                            </div>
                            <span class="arrow">&rarr;</span>
                            <a href="#" target="_blank" class="base-step step-quality-color" id="asgCalidadTextil">
                                <span>ASG. CALIDAD TEXTIL</span>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" id="asgCalidadTextilFill"></div>
                                </div>
                                <span class="progress-percentage" id="asgCalidadTextilPercentage"></span>
                            </a>
                        </div>

                        <div class="vertical-connector"></div>

                        <div class="main-flow-row">
                            <a href="#" target="_blank" class="base-step step-strategic-color" id="desarrolloConfecciones">
                                <span>DESARROLLO CONFECCIONES</span>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" id="desarrolloConfeccionesFill"></div>
                                </div>
                                <span class="progress-percentage" id="desarrolloConfeccionesPercentage"></span>
                            </a>
                            <span class="arrow">&rarr;</span>
                            <div class="base-step step-container-general step-principal-container-color" id="pManufactura">
                                <span class="container-title">CONFECCIONES</span>
                                <div class="sub-steps-wrapper">
                                    <a href="#" target="_blank" class="base-step step-default-color" id="corteHabilitado">
                                        <span>CORTE Y HABILITADO</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar-fill" id="corteHabilitadoFill"></div>
                                        </div>
                                        <span class="progress-percentage" id="corteHabilitadoPercentage"></span>
                                    </a>
                                    <a href="#" target="_blank" class="base-step step-default-color" id="costura">
                                        <span>COSTURA</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar-fill" id="costuraFill"></div>
                                        </div>
                                        <span class="progress-percentage" id="costuraPercentage"></span>
                                    </a>
                                    <a href="#" target="_blank" class="base-step step-default-color" id="acabadoEmbalaje">
                                        <span>ACABADO Y EMBALAJE</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar-fill" id="acabadoEmbalajeFill"></div>
                                        </div>
                                        <span class="progress-percentage" id="acabadoEmbalajePercentage"></span>
                                    </a>
                                    <a href="#" target="_blank" class="base-step step-default-color" id="bordado">
                                        <span>BORDADO</span>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar-fill" id="bordadoFill"></div>
                                        </div>
                                        <span class="progress-percentage" id="bordadoPercentage"></span>
                                    </a>
                                </div>
                                <div class="progress-bar-container" style="margin-top: 10px;">
                                    <div class="progress-bar-fill" id="pManufacturaFill"></div>
                                </div>
                                <span class="progress-percentage" id="pManufacturaPercentage"></span>
                            </div>
                            <span class="arrow">&rarr;</span>
                            <a href="#" target="_blank" class="base-step step-quality-color" id="asgCalidadConfecciones">
                                <span>ASG. CALIDAD CONFECCIONES</span>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" id="asgCalidadConfeccionesFill"></div>
                                </div>
                                <span class="progress-percentage" id="asgCalidadConfeccionesPercentage"></span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="process-section-box support-section">
        <div class="section-title">
            PROCESOS DE SOPORTE
            <span class="category-progress-percentage" id="supportCategoryPercentage"></span>
        </div>
        <div class="process-map">
            <a href="#" target="_blank" class="base-step step-support-color" id="compras">
                <span>COMPRAS</span>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="comprasFill"></div>
                </div>
                <span class="progress-percentage" id="comprasPercentage"></span>
            </a>
            <a href="#" target="_blank" class="base-step step-support-color base-step-long-label" id="almMateriaPrima">
                <span>ALM. DE MATERIA PRIMA</span>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="almMateriaPrimaFill"></div>
                </div>
                <span class="progress-percentage" id="almMateriaPrimaPercentage"></span>
            </a>
            <a href="#" target="_blank" class="base-step step-support-color" id="almHilos">
                <span>ALM. DE HILOS</span>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="almHilosFill"></div>
                </div>
                <span class="progress-percentage" id="almHilosPercentage"></span>
            </a>
            <a href="#" target="_blank" class="base-step step-support-color base-step-long-label" id="almTelaAcabada">
                <span>ALM. DE TELA ACABada</span>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="almTelaAcabadaFill"></div>
                </div>
                <span class="progress-percentage" id="almTelaAcabadaPercentage"></span>
            </a>
            <a href="#" target="_blank" class="base-step step-support-color base-step-long-label" id="almDespachoAvios">
                <span>ALM. Y DESPACHO DE AVIOS</span>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="almDespachoAviosFill"></div>
                </div>
                <span class="progress-percentage" id="almDespachoAviosPercentage"></span>
            </a>
            <a href="#" target="_blank" class="base-step step-support-color" id="servicios">
                <span>SERVICIOS</span>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="serviciosFill"></div>
                </div>
                <span class="progress-percentage" id="serviciosPercentage"></span>
            </a>
            <a href="#" target="_blank" class="base-step step-support-color base-step-long-label" id="gestionAdministrativa">
                <span>GESTION ADMINISTRATIVA</span>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="gestionAdministrativaFill"></div>
                </div>
                <span class="progress-percentage" id="gestionAdministrativaPercentage"></span>
            </a>
        </div>
        <div class="process-map">
            <a href="#" target="_blank" class="base-step step-support-color" id="gestionTi">
                <span>GESTION DE TI</span>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="gestionTiFill"></div>
                </div>
                <span class="progress-percentage" id="gestionTiPercentage"></span>
            </a>
            <a href="#" target="_blank" class="base-step step-support-color" id="mantenimiento">
                <span>MANTENIMIENTO</span>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="mantenimientoFill"></div>
                </div>
                <span class="progress-percentage" id="mantenimientoPercentage"></span>
            </a>
            <a href="#" target="_blank" class="base-step step-support-color base-step-long-label" id="ingTiempoMetodos">
                <span>ING. TIEMPO Y METODOS</span>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="ingTiempoMetodosFill"></div>
                </div>
                <span class="progress-percentage" id="ingTiempoMetodosPercentage"></span>
            </a>
            <a href="#" target="_blank" class="base-step step-support-color" id="labTintoreria">
                <span>LAB. DE TINTORERIA</span>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="labTintoreriaFill"></div>
                </div>
                <span class="progress-percentage" id="labTintoreriaPercentage"></span>
            </a>
            <a href="#" target="_blank" class="base-step step-support-color" id="gestionRrhh">
                <span>GESTION DE RRHH</span>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="gestionRrhhFill"></div>
                </div>
                <span class="progress-percentage" id="gestionRrhhPercentage"></span>
            </a>
            <a href="#" target="_blank" class="base-step step-support-color" id="ptari">
                <span>PTARI</span>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="ptariFill"></div>
                </div>
                <span class="progress-percentage" id="ptariPercentage"></span>
            </a>
            <a href="#" target="_blank" class="base-step step-support-color base-step-long-label" id="gestionSeguridad">
                <span>GESTION DE LA SEGURIDAD</span>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="gestionSeguridadFill"></div>
                </div>
                <span class="progress-percentage" id="gestionSeguridadPercentage"></span>
            </a>
        </div>
    </div>
</div>

<!-- MODAL DETALLES -->
<div id="details-modal">
    <div class="modal-content">
        <span class="modal-close" id="details-modal-close-button">&times;</span>
        <h2 id="modal-title">Detalle de Proyectos</h2>
        <div class="modal-table-wrapper">
            <table class="modal-table">
                <thead>
                    <tr>
                        <th>n</th>
                        <th>PROYECTO</th>
                        <th>TAREA</th>
                        <th>HERRAMIENTA</th>
                        <th>ESTADO</th>
                    </tr>
                </thead>
                <tbody id="modal-table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL INFORME (BLOQUES) -->
<div id="informe-modal">
    <div class="modal-content">
        <span class="modal-close" id="informe-modal-close">&times;</span>
        <div class="informe-header">
            <h2 id="informe-modal-title">Informe de Proyectos</h2>
            <div class="informe-controls">
                <div class="informe-legend" aria-hidden="true">
                    <div class="legend-item"><span class="legend-bullet-check legend-terminado">✔</span><span class="legend-text">Terminado</span></div>
                    <div class="legend-item"><span class="legend-bullet-small legend-en-proceso"></span><span class="legend-text">En proceso</span></div>
                    <div class="legend-item"><span class="legend-bullet-small legend-estacionamiento"></span><span class="legend-text">Estacionamiento</span></div>
                </div>
                <label class="toggle-switch" title="Mostrar sólo En proceso + Terminado recientes">
                    <input type="checkbox" id="informe-toggle-switch">
                    <span class="toggle-slider" aria-hidden="true"></span>
                    <span class="toggle-label">Quick-wins</span>
                </label>
            </div>
        </div>

        <div class="modal-table-wrapper informe-wrapper" id="informe-modal-body"></div>
    </div>
</div>

<!-- MODAL A.CAMBIO -->
<div id="acambio-modal">
    <div class="modal-content">
        <span class="modal-close" id="acambio-modal-close">&times;</span>
        <h2 id="acambio-modal-title">Dashboard A.cambio</h2>
        <div class="modal-table-wrapper acambio-wrapper" id="acambio-modal-body"></div>
    </div>
</div>

<!-- MODAL KANBAN -->
<div id="kanban-modal">
    <div class="kanban-content">
        <span class="modal-close" id="kanban-modal-close-button">&times;</span>
        <h2>Vista Kanban</h2>
        <div class="kanban-board">
            <div class="kanban-column" id="kanban-col-estacionamiento">
                <h3>Estacionamiento</h3>
            </div>
            <div class="kanban-column" id="kanban-col-en-proceso">
                <h3>En proceso</h3>
            </div>
            <div class="kanban-column" id="kanban-col-terminado">
                <h3>Terminado</h3>
            </div>
        </div>
    </div>
</div>

<script>
const SHEET_ID    = '1lRBoAr2JN2elTtB9QgmvIYNIq1zsxvBENpuwzjIuZt4';
const SHEET_NAME_BD = 'Bd';
const SHEET_NAME_KANBAN = 'Kanban';
const SHEET_NAME_ACAMBIO = 'A_cambio';

const HORAS_COLUMN_NAME = 'HRS PROY.(AÑO)';
const HORAS_ACTUAL_COLUMN_NAME = 'HRS AHORRADO (ACTUAL)';

document.addEventListener('DOMContentLoaded', () => {
    const $loading = document.getElementById('loading-overlay');
    const $error   = document.getElementById('error-banner');
    const showLoading = () => { $loading.style.display = 'flex'; };
    const hideLoading = () => { $loading.style.display = 'none'; };
    const showError = (msg) => { $error.textContent = msg; $error.style.display = 'block'; };

    let allRowsData = [];
    let kanbanData = [];
    let aCambioData = [];
    let processedStats = {};

    const $detailsModal = document.getElementById('details-modal');
    const $detailsModalClose = document.getElementById('details-modal-close-button');
    const $modalTitle = document.getElementById('modal-title');
    const $modalTableBody = document.getElementById('modal-table-body');

    const $informeButton = document.getElementById('informe-button');
    const $informeModal = document.getElementById('informe-modal');
    const $informeModalClose = document.getElementById('informe-modal-close');
    const $informeModalBody = document.getElementById('informe-modal-body');

    const $kanbanButton = document.getElementById('kanban-button');
    const $ganttButton = document.getElementById('gantt-button');
    const $acambioButton = document.getElementById('acambio-button');
    const $acambioModal = document.getElementById('acambio-modal');
    const $acambioModalClose = document.getElementById('acambio-modal-close');
    const $acambioModalBody = document.getElementById('acambio-modal-body');
    // Open standalone Gantt page (external file)
    if ($ganttButton) {
        $ganttButton.addEventListener('click', () => {
            try {
                const url = 'gantt.html';
                window.open(url, '_blank');
            } catch (e) {
                // fallback to embedded modal if popups are blocked
                const main = document.querySelector('.main-layout-container');
                const ganttModal = document.getElementById('gantt-modal');
                if (main) main.style.display = 'none';
                if (ganttModal) {
                    ganttModal.style.display = 'block';
                    if (typeof window.ganttRender === 'function') window.ganttRender();
                }
            }
        });
    }
    const $kanbanModal = document.getElementById('kanban-modal');
    const $kanbanModalClose = document.getElementById('kanban-modal-close-button');
    const $kanbanColEstacionamiento = document.getElementById('kanban-col-estacionamiento');
    const $kanbanColEnProceso = document.getElementById('kanban-col-en-proceso');
    const $kanbanColTerminado = document.getElementById('kanban-col-terminado');

    function formatNumber(num) {
        return Math.round(num).toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
    }

    function formatNumberOneDecimal(num) {
        return (num || 0).toFixed(1).replace(/(\d)(?=(\d{3})+\.)/g, '$1,');
    }

    function formatShortDate(value) {
        if (!value && value !== 0) return '';
        try {
            const meses = ['ene','feb','mar','abr','may','jun','jul','ago','set','oct','nov','dic'];
            const formatDMY = (day, monthIndex, year) => {
                if (monthIndex < 0 || monthIndex > 11) return '';
                const d = String(day).padStart(2,'0');
                const m = meses[monthIndex];
                return `${d}/${m}/${year}`;
            };

            if (value instanceof Date) {
                return formatDMY(value.getDate(), value.getMonth(), value.getFullYear());
            }

            const str = String(value).trim();
            if (!str) return '';

            // Manejar formato especial de Google Sheets: Date(2025,7,1)
            const dateMatch = str.match(/Date\((\d+),\s*(\d+),\s*(\d+)\)/);
            if (dateMatch) {
                const year = parseInt(dateMatch[1]);
                const month = parseInt(dateMatch[2]); // mes en Google Sheets (0-11)
                const day = parseInt(dateMatch[3]);
                return formatDMY(day, month, year);
            }

            // ISO: yyyy-mm-dd
            const isoMatch = str.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
            if (isoMatch) {
                const year = parseInt(isoMatch[1], 10);
                const month = parseInt(isoMatch[2], 10) - 1;
                const day = parseInt(isoMatch[3], 10);
                return formatDMY(day, month, year);
            }

            // Slash format: dd/mm/yyyy or yyyy/mm/dd
            const slashMatch = str.match(/^(\d{1,4})[\\/](\d{1,2})[\\/](\d{1,4})/);
            if (slashMatch) {
                if (slashMatch[1].length === 4) {
                    const year = parseInt(slashMatch[1], 10);
                    const month = parseInt(slashMatch[2], 10) - 1;
                    const day = parseInt(slashMatch[3], 10);
                    const formatted = formatDMY(day, month, year);
                    if (formatted) return formatted;
                } else {
                    const day = parseInt(slashMatch[1], 10);
                    const month = parseInt(slashMatch[2], 10) - 1;
                    const year = parseInt(slashMatch[3], 10);
                    const formatted = formatDMY(day, month, year);
                    if (formatted) return formatted;
                }
            }

            // dd/mes, dd/mes/yyyy, dd-mes, dd-mes-yyyy
            const match = str.match(/^(\d{1,2})[-/](\w{3,})(?:[-/](\d{4}))?/i);
            if (match) {
                const d = match[1];
                let mon = match[2].toLowerCase().replace('.','');
                if (mon.startsWith('set')) mon = 'set';
                const monthIndex = meses.indexOf(mon);
                if (monthIndex >= 0) {
                    const year = match[3] ? parseInt(match[3], 10) : new Date().getFullYear();
                    const formatted = formatDMY(d, monthIndex, year);
                    if (formatted) return formatted;
                }
            }

            const parsed = new Date(str);
            if (!isNaN(parsed)) {
                return formatDMY(parsed.getDate(), parsed.getMonth(), parsed.getFullYear());
            }

            return str;
        } catch (e) {
            return '';
        }
    }

    // Parse a variety of date formats into a Date object (or return null)
    function parseDateValue(value) {
        if (!value && value !== 0) return null;
        try {
            if (value instanceof Date) return value;
            const str = String(value).trim();
            if (!str) return null;

            // Google Sheets JSON sometimes returns Date(YYYY,MM,DD)
            const dateMatch = str.match(/Date\((\d+),\s*(\d+),\s*(\d+)\)/);
            if (dateMatch) {
                const year = parseInt(dateMatch[1], 10);
                const month = parseInt(dateMatch[2], 10); // 0-based
                const day = parseInt(dateMatch[3], 10);
                return new Date(year, month, day);
            }

            // Try native parse
            const parsed = new Date(str);
            if (!isNaN(parsed)) return parsed;

            // Try short form like 15/ago or 15-ago (assume current year)
            const meses = ['ene','feb','mar','abr','may','jun','jul','ago','set','oct','nov','dic'];
            const match = str.match(/^(\d{1,2})[-/](\w{3,})/i);
            if (match) {
                const day = parseInt(match[1], 10);
                let mon = match[2].toLowerCase().replace('.','');
                if (mon.startsWith('set')) mon = 'set';
                const mIndex = meses.indexOf(mon);
                if (mIndex >= 0) {
                    const year = new Date().getFullYear();
                    return new Date(year, mIndex, day);
                }
            }

            return null;
        } catch (e) {
            return null;
        }
    }

    function alignColumnHeights() {
        const mainColumn = document.querySelector('.main-column');
        const strategicColumn = document.querySelector('.strategic-column');

        if (mainColumn && strategicColumn) {
            strategicColumn.style.height = 'auto';
            const mainHeight = mainColumn.offsetHeight;
            strategicColumn.style.height = `${mainHeight}px`;
        }
    }

    const mapStructure = {
        planeamiento: ['pcpTextil', 'pcpConfecciones'],
        pTextiles: ['hilanderia', 'tejeduria', 'tintoreria', 'lavanderia', 'estampado'],
        pManufactura: ['corteHabilitado', 'bordado', 'costura', 'acabadoEmbalaje'],
        strategicCategory: ['altaDireccion', 'sostenibilidad', 'planeamiento', 'comercial'],
        principalesCategory: ['desarrolloTextil', 'pTextiles', 'asgCalidadTextil', 'desarrolloConfecciones', 'pManufactura', 'asgCalidadConfecciones'],
        supportCategory: ['compras','almMateriaPrima','almHilos','almTelaAcabada','almDespachoAvios','servicios','gestionAdministrativa','gestionTi','mantenimiento','ingTiempoMetodos','labTintoreria','gestionRrhh','ptari','gestionSeguridad']
    };

    const areaNameToIdMap = {
        'ALTA DIRECCION':'altaDireccion','SOSTENIBILIDAD':'sostenibilidad','PLANEAMIENTO':'planeamiento',
        'PCP TEXTIL':'pcpTextil','PCP CONFECCIONES':'pcpConfecciones','COMERCIAL':'comercial',
        'DESARROLLO TEXTIL':'desarrolloTextil','TEXTIL':'pTextiles','HILANDERIA':'hilanderia',
        'TEJEDURIA':'tejeduria','TINTORERIA':'tintoreria','LAVANDERIA':'lavanderia','ESTAMPADO':'estampado',
        'ASG. CALIDAD TEXTIL':'asgCalidadTextil','DESARROLLO CONFECCIONES':'desarrolloConfecciones',
        'CONFECCIONES':'pManufactura','CORTE Y HABILITADO':'corteHabilitado','COSTURA':'costura',
        'ACABADO Y EMBALAJE':'acabadoEmbalaje','BORDADO':'bordado','ASG. CALIDAD CONFECCIONES':'asgCalidadConfecciones',
        'COMPRAS':'compras','ALM. DE MATERIA PRIMA':'almMateriaPrima','ALM. DE HILOS':'almHilos',
        'ALM. DE TELA ACABADA':'almTelaAcabada','ALM. Y DESPACHO DE AVIOS':'almDespachoAvios',
        'SERVICIOS':'servicios','GESTION ADMINISTRATIVA':'gestionAdministrativa','GESTION DE TI':'gestionTi',
        'MANTENIMIENTO':'mantenimiento','ING. TIEMPO Y METODOS':'ingTiempoMetodos',
        'LAB. DE TINTORERIA':'labTintoreria','GESTION DE RRHH':'gestionRrhh','PTARI':'ptari',
        'GESTION DE LA SEGURIDAD':'gestionSeguridad'
    };

    const idToAreaNameMap = Object.entries(areaNameToIdMap).reduce((acc, [name, id]) => {
        acc[id] = name;
        return acc;
    }, {});

    function updateMapWithData(rows) {
        processedStats = {};
        const globalStats = { total: 0, Terminado: 0, "En proceso": 0, "Estacionamiento": 0 };
        const allIds = new Set(Object.values(areaNameToIdMap));

        let totalHrsActualGlobal = 0;
        let totalHrsProyGlobal = 0;

        allIds.forEach(id => processedStats[id] = { total: 0, Terminado: 0, "En proceso": 0, "Estacionamiento": 0, hrsProy: 0 });

        rows.forEach(row => {
            const rawAreaName = row.AREA ? String(row.AREA).trim().toUpperCase() : undefined;
            const id = areaNameToIdMap[rawAreaName];
            const estadoRaw = row.ESTADO ? String(row.ESTADO).trim().toLowerCase() : undefined;

            let hrsRaw = row[HORAS_COLUMN_NAME] ? String(row[HORAS_COLUMN_NAME]) : '0';
            hrsRaw = hrsRaw.replace(/[$,\s]/g, '');
            const hrs = parseFloat(hrsRaw) || 0;

            let hrsActualRaw = row[HORAS_ACTUAL_COLUMN_NAME] ? String(row[HORAS_ACTUAL_COLUMN_NAME]) : '0';
            hrsActualRaw = hrsActualRaw.replace(/[$,\s]/g, '');
            const hrsActual = parseFloat(hrsActualRaw) || 0;

            if (!isNaN(hrsActual)) {
                totalHrsActualGlobal += hrsActual;
            }

            if ((estadoRaw === 'terminado' || estadoRaw === 'en proceso') && !isNaN(hrs)) {
                totalHrsProyGlobal += hrs;
            }

            if (id && processedStats[id]) {
                processedStats[id].total++;
                globalStats.total++;

                if (estadoRaw === 'terminado') {
                    processedStats[id].Terminado++;
                    globalStats.Terminado++;
                } else if (estadoRaw === 'en proceso') {
                    processedStats[id]["En proceso"]++;
                    globalStats["En proceso"]++;
                } else if (estadoRaw === 'estacionamiento') {
                    processedStats[id]["Estacionamiento"]++;
                    globalStats.Estacionamiento++;
                }

                if ((estadoRaw === 'terminado' || estadoRaw === 'en proceso') && !isNaN(hrs)) {
                    processedStats[id].hrsProy += hrs;
                }
            }
        });

        for (const id in processedStats) {
            const s = processedStats[id];
            s.percentage = s.total > 0 ? (s.Terminado / s.total) * 100 : 0;
        }

        function calculateAverage(childrenIds) {
            let totalProjects = 0, totalFinished = 0;
            childrenIds.forEach(id => {
                const c = processedStats[id];
                if (c) {
                    totalProjects += c.total;
                    totalFinished += c.Terminado;
                }
            });
            return totalProjects > 0 ? (totalFinished / totalProjects) * 100 : 0;
        }

        function aggregateChildStats(childrenIds) {
            const a = { total: 0, Terminado: 0, "En proceso": 0, "Estacionamiento": 0, hrsProy: 0 };
            childrenIds.forEach(id => {
                const c = processedStats[id];
                if (c) {
                    a.total += c.total;
                    a.Terminado += c.Terminado;
                    a["En proceso"] += c["En proceso"];
                    a["Estacionamiento"] += c["Estacionamiento"];
                    a.hrsProy += (c.hrsProy || 0);
                }
            });
            return a;
        }

        const planeamientoStats = aggregateChildStats(mapStructure.planeamiento);
        processedStats.planeamiento = { ...planeamientoStats, percentage: calculateAverage(mapStructure.planeamiento) };

        const pTextilesStats = aggregateChildStats(mapStructure.pTextiles);
        processedStats.pTextiles = { ...pTextilesStats, percentage: calculateAverage(mapStructure.pTextiles) };

        const pManufacturaStats = aggregateChildStats(mapStructure.pManufactura);
        processedStats.pManufactura = { ...pManufacturaStats, percentage: calculateAverage(mapStructure.pManufactura) };

        const strategicCategoryStats = aggregateChildStats(mapStructure.strategicCategory);
        processedStats.strategicCategoryPercentage = { ...strategicCategoryStats, percentage: calculateAverage(mapStructure.strategicCategory) };

        const principalesCategoryStats = aggregateChildStats(mapStructure.principalesCategory);
        processedStats.principalesCategoryPercentage = { ...principalesCategoryStats, percentage: calculateAverage(mapStructure.principalesCategory) };

        const supportCategoryStats = aggregateChildStats(mapStructure.supportCategory);
        processedStats.supportCategoryPercentage = { ...supportCategoryStats, percentage: calculateAverage(mapStructure.supportCategory) };

        updateSummaryBox(globalStats, totalHrsProyGlobal, totalHrsActualGlobal);

        function updateElementUI(id, stats) {
            const rounded = Math.round(stats.percentage || 0);
            const totalProjects = stats.total || 0;
            const finished = stats.Terminado || 0;
            const hours = stats.hrsProy || 0;
            const formattedHours = formatNumber(hours);

            if (id.includes('CategoryPercentage')) {
                const catEl = document.getElementById(id);
                if (catEl) {
                    catEl.textContent = `${rounded}% (${finished}/${totalProjects}) [${formattedHours}hrs]`;
                }
                return;
            }

            const element = document.getElementById(id);
            if (!element) return;

            const fillEl = document.getElementById(id + 'Fill');
            const percentEl = document.getElementById(id + 'Percentage');

            if (fillEl) fillEl.style.width = rounded + '%';
            if (percentEl) percentEl.textContent = `${rounded}% (${finished}/${totalProjects}) [${formattedHours}hrs]`;

            const titleSpan = element.querySelector('span:first-child');
            if (!titleSpan) return;

            const areaName = titleSpan.textContent || '';
            let tooltipText = `${areaName} (${rounded}%)\n`;

            if (stats.total > 0) {
                tooltipText += `En proceso: ${stats["En proceso"]}\nEstacionamiento: ${stats["Estacionamiento"]}\nTerminado: ${stats.Terminado}\nHoras Sumadas: ${formattedHours}`;
            } else {
                tooltipText += `0 proyectos`;
            }

            element.setAttribute('title', tooltipText);
        }

        for (const id in processedStats) {
            updateElementUI(id, processedStats[id]);
        }
    }

    function updateSummaryBox(stats, totalHrs, totalHrsActual) {
        const total = stats.total;
        const t = total ? Math.round((stats.Terminado / total) * 100) : 0;
        const p = total ? Math.round((stats["En proceso"] / total) * 100) : 0;
        const e = total ? Math.round((stats.Estacionamiento / total) * 100) : 0;

        const formattedTotalHrs = formatNumber(totalHrs || 0);
        const formattedTotalHrsActual = formatNumberOneDecimal(totalHrsActual || 0);

        const personasActual = (totalHrsActual || 0) / 2304;
        const personasProy = (totalHrs || 0) / 2304;

        const formattedPersonasActual = personasActual.toFixed(1) + ' personas';
        const formattedPersonasProy = personasProy.toFixed(1) + ' personas';

        const summaryTotalCount = document.getElementById('summary-total-count');
        if (summaryTotalCount) {
            summaryTotalCount.textContent = `Total ${total}`;
        }

        document.getElementById('summary-terminado').textContent = `Terminado ${t}% [${stats.Terminado}]`;
        document.getElementById('summary-en-proceso').textContent = `En proceso ${p}% [${stats["En proceso"]}]`;
        document.getElementById('summary-estacionamiento').textContent = `Estacionamiento ${e}% [${stats.Estacionamiento}]`;

        const summaryHoursActual = document.getElementById('summary-hours-actual');
        if (summaryHoursActual) {
            summaryHoursActual.textContent = `${formattedTotalHrsActual} hrs actual`;
            summaryHoursActual.setAttribute('title', formattedPersonasActual);
        }

        const summaryHoursProy = document.getElementById('summary-hours-proy');
        if (summaryHoursProy) {
            summaryHoursProy.textContent = `${formattedTotalHrs} hrs proy/año`;
            summaryHoursProy.setAttribute('title', formattedPersonasProy);
        }
    }

    function gvizToObjects(resp) {
        if (!resp || !resp.table) return [];
        const seenHeaders = new Map();
        const cols = (resp.table.cols || []).map(c => {
            const base = String(c.label || c.id || '').trim().toUpperCase();
            const count = (seenHeaders.get(base) || 0) + 1;
            seenHeaders.set(base, count);
            return count > 1 ? `${base}_${count}` : base;
        });
        return (resp.table.rows || []).map(r => {
            const o = {};
            cols.forEach((h, i) => {
                const cell = r.c && r.c[i] ? r.c[i] : null;
                o[h] = cell && (cell.v !== null && cell.v !== undefined) ? cell.v : '';
            });
            return o;
        });
    }

    function loadSheetJSONP(sheetId, sheetName) {
        const TIMEOUT_MS = 15000;

        return new Promise((resolve, reject) => {
            const cbName = 'GVIZ_CB_' + Math.random().toString(36).slice(2);
            let script = document.createElement('script');
            let timer = null;

            function cleanup() {
                if (timer) {
                    clearTimeout(timer);
                    timer = null;
                }
                delete window[cbName];
                if (script && script.parentNode) {
                    script.parentNode.removeChild(script);
                    script = null;
                }
            }

            timer = setTimeout(() => {
                cleanup();
                reject(new Error(`Tiempo de espera agotado al cargar "${sheetName}".`));
            }, TIMEOUT_MS);

            window[cbName] = function (resp) {
                cleanup();
                try {
                    resolve(gvizToObjects(resp));
                } catch (e) {
                    reject(e);
                }
            };

            script.onerror = (err) => {
                cleanup();
                reject(new Error(`No se pudo cargar la hoja "${sheetName}".`));
            };

            const base = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq`;
            const url  = `${base}?sheet=${encodeURIComponent(sheetName)}&headers=1&tq=${encodeURIComponent('select *')}&tqx=out:json;responseHandler:${cbName}&nocache=${Date.now()}`;

            script.src = url;
            document.head.appendChild(script);
        });
    }

    const statusOrder = { 'terminado': 1, 'en proceso': 2, 'estacionamiento': 3 };

    function openDetailsModal(areaId) {
        const areaName = idToAreaNameMap[areaId];
        if (!areaName) return;
        const stats = processedStats[areaId];
        if (!stats) return;

        const rounded = Math.round(stats.percentage || 0);
        const totalProjects = stats.total || 0;
        const finished = stats.Terminado || 0;
        const hours = stats.hrsProy || 0;
        const formattedHours = formatNumber(hours);

        $modalTitle.innerHTML = `Proyectos: ${areaName} <span class="modal-title-stats">${rounded}% (${finished}/${totalProjects}) [${formattedHours}hrs]</span>`;
        $modalTableBody.innerHTML = '';

        const filteredRows = allRowsData.filter(row =>
            (row.AREA ? row.AREA.trim().toUpperCase() : '') === areaName
        );

        filteredRows.sort((a, b) => {
            const statusA = (a.ESTADO || '').toLowerCase();
            const statusB = (b.ESTADO || '').toLowerCase();
            const orderA = statusOrder[statusA] || 99;
            const orderB = statusOrder[statusB] || 99;
            return orderA - orderB;
        });

        let tableHtml = '';
        let n = 1;
        if (filteredRows.length === 0) {
            tableHtml = '<tr><td colspan="5" style="text-align:center;">No hay proyectos para mostrar.</td></tr>';
        } else {
            filteredRows.forEach(row => {
                let statusClass = '';
                const estadoLower = (row.ESTADO || '').toLowerCase();
                if (estadoLower === 'terminado') statusClass = 'status-terminado';
                else if (estadoLower === 'en proceso') statusClass = 'status-en-proceso';
                else if (estadoLower === 'estacionamiento') statusClass = 'status-estacionamiento';

                tableHtml += `
                    <tr>
                        <td>${n++}</td>
                        <td>${row.PROYECTO || ''}</td>
                        <td>${row.TAREA || ''}</td>
                        <td>${row.HERRAMIENTA || ''}</td>
                        <td class="${statusClass}">${row.ESTADO || ''}</td>
                    </tr>`;
            });
        }
        $modalTableBody.innerHTML = tableHtml;
        $detailsModal.style.display = 'block';
    }

    function setupDetailsModalListeners() {
        document.querySelectorAll('.base-step[id]:not(.step-container-general)').forEach(areaElement => {
            areaElement.addEventListener('click', (e) => {
                e.preventDefault();
                openDetailsModal(areaElement.id);
            });
        });

        $detailsModalClose.addEventListener('click', () => $detailsModal.style.display = 'none');
        $detailsModal.addEventListener('click', (e) => {
            if (e.target === $detailsModal) $detailsModal.style.display = 'none';
        });
    }

    // === MODAL INFORME EN BLOQUES ===
    function openInformeModal() {
        if (!allRowsData || allRowsData.length === 0) {
            showError("No hay datos para generar el informe.");
            return;
        }

        // Debug: mostrar las columnas disponibles en consola
        if (allRowsData.length > 0) {
            console.log('Columnas disponibles:', Object.keys(allRowsData[0]));
            console.log('Ejemplo de fila:', allRowsData[0]);
        }

        // Build a normalized map of projects (keyed by uppercase name) so we can order them
        const proyectosMap = new Map();
        allRowsData.forEach(row => {
            const proyecto = (row.PROYECTO || '').toString().trim();
            if (!proyecto) return;
            const key = proyecto.toUpperCase();
            if (!proyectosMap.has(key)) proyectosMap.set(key, { name: proyecto, rows: [] });
            proyectosMap.get(key).rows.push(row);
        });

        // Desired order (uppercase keys)
        const desiredOrder = [
            'AUTOMATIZAR LA CREACION DE OPS',
            'LIQUIDACION PRENDAS',
            'CONTROL DE PISO COSTURA',
            'CONTROL PRODUCCION TINTORERIA',
            'FLUJO DE OC',
            'PROCESO DE PAGOS',
            'REDISEÑO TEJEDURIA (ITP)',
            'DASHBOAR ASEG. CAL. CONF (ITP)',
            'ANALIZADOR PCP TEXTIL (ITP)',
            'COTIZACION 2.0 (ITP)',
            'OTROS'
        ];

        // Build ordered list: follow desiredOrder; insert any other projects between
        // 'COTIZACION 2.0 (ITP)' and 'OTROS'
        const orderedProjects = [];
        // Helper set for quick lookup
        const desiredSet = new Set(desiredOrder.map(s => s.toUpperCase()));

        for (let i = 0; i < desiredOrder.length; i++) {
            const key = desiredOrder[i];
            if (key === 'COTIZACION 2.0 (ITP)') {
                // push Cotizacion if exists
                if (proyectosMap.has(key)) {
                    orderedProjects.push(proyectosMap.get(key));
                    proyectosMap.delete(key);
                }
                // insert any remaining projects that are not in desiredOrder (these are "otros nombres")
                const others = Array.from(proyectosMap.keys()).filter(k => !desiredSet.has(k) && k !== 'OTROS');
                others.sort();
                others.forEach(k => {
                    orderedProjects.push(proyectosMap.get(k));
                    proyectosMap.delete(k);
                });
                continue;
            }
            if (proyectosMap.has(key)) {
                orderedProjects.push(proyectosMap.get(key));
                proyectosMap.delete(key);
            }
        }

        // If OTROS remains, push it at the end
        if (proyectosMap.has('OTROS')) {
            orderedProjects.push(proyectosMap.get('OTROS'));
            proyectosMap.delete('OTROS');
        }

        // Any remaining projects (unlikely) push before OTROS (already placed) — append at end
        const remainingKeys = Array.from(proyectosMap.keys()).sort();
        remainingKeys.forEach(k => orderedProjects.push(proyectosMap.get(k)));

        let html = '';

        orderedProjects.forEach(projectItem => {
            const proyectoName = (projectItem.name || '').toString().toUpperCase();
            const rows = projectItem.rows || [];

            html += `
            <div class="informe-project-block">
              <div class="informe-project-header">
                ${proyectoName}
              </div>
              <table class="informe-table">
                <thead>
                  <tr>
                    <th style="width: 4%;"></th>
                    <th style="width: 25%;">TAREA</th>
                    <th style="width: 8%;">%AVANCE</th>
                    <th style="width: 8%;">F.INICIO</th>
                    <th style="width: 8%;">F.FIN</th>
                    <th style="width: 30%;">OBSERVACION</th>
                    <th style="width: 10%;">HRS PROY.(AÑO)</th>
                  </tr>
                </thead>
                <tbody>
            `;

            rows.forEach(r => {
                const estado = (r.ESTADO || '').toString();
                const estadoLower = estado.toLowerCase();
                // Filtrado según el estado del toggle
                try {
                    const ffinDate = parseDateValue(r['F.FIN']);
                    const toggle = document.getElementById('informe-toggle-switch');
                    const switchOn = toggle ? toggle.checked : false;
                    const now = new Date();

                    if (switchOn) {
                        // Modo toggle activo: mostrar sólo 'en proceso' (todos)
                        // y 'terminado' solo si F.FIN existe y es <= 7 días
                        if (estadoLower === 'en proceso') {
                            // show
                        } else if (estadoLower === 'terminado') {
                            if (!ffinDate) return; // exclude if no finish date
                            const diffDays = (now - ffinDate) / (1000 * 60 * 60 * 24);
                            if (diffDays > 7) return; // exclude older than 7 days
                        } else {
                            return; // exclude other statuses
                        }
                    } else {
                        // Modo normal: exclude 'terminado' only if F.FIN > 14 días (keep other rows)
                        if (estadoLower === 'terminado' && ffinDate) {
                            const diffDays = (now - ffinDate) / (1000 * 60 * 60 * 24);
                            if (diffDays > 14) {
                                return; // saltar esta fila
                            }
                        }
                    }
                } catch (e) {
                    // ignore parsing errors and show the row
                }

                let statusClass = '';
                                if (estadoLower === 'terminado') statusClass = 'status-terminado';
                                else if (estadoLower === 'en proceso') statusClass = 'status-en-proceso';
                                else if (estadoLower === 'estacionamiento') statusClass = 'status-estacionamiento';

                                // Icona / viñeta para estado
                                let estadoIcon = '';
                                if (estadoLower === 'terminado') {
                                        estadoIcon = `<span class="estado-bullet estado-terminado" title="Terminado">&#10003;</span>`; // check
                                } else if (estadoLower === 'en proceso') {
                                        estadoIcon = `<span class="estado-bullet estado-en-proceso" title="En proceso"></span>`;
                                } else if (estadoLower === 'estacionamiento') {
                                        estadoIcon = `<span class="estado-bullet estado-estacionamiento" title="Estacionamiento"></span>`;
                                } else {
                                        estadoIcon = `<span class="estado-bullet" title="${estado}"></span>`;
                                }

                                // Format %AVANCE as percentage (treat 1 as 100%) and prepare a visual bar
                                let avance = '';
                                let avanceHtml = '';
                                const avanceValue = r['%AVANCE'];
                                let avancePercent = null;
                                if (avanceValue !== undefined && avanceValue !== null && avanceValue !== '') {
                                    const avanceNum = parseFloat(avanceValue);
                                    if (!isNaN(avanceNum)) {
                                        if (avanceNum <= 1 && avanceNum >= 0) {
                                            avancePercent = Math.round(avanceNum * 100);
                                        } else {
                                            avancePercent = Math.round(avanceNum);
                                        }
                                        // clamp 0..100
                                        avancePercent = Math.max(0, Math.min(100, avancePercent));
                                        avance = avancePercent + '%';
                                    } else {
                                        avance = String(avanceValue);
                                    }
                                }

                                if (avancePercent !== null) {
                                    avanceHtml = `<div class="avance-cell"><div class="avance-bar-container"><div class="avance-bar-fill" style="width:${avancePercent}%;"></div></div><div class="avance-label">${avancePercent}%</div></div>`;
                                } else {
                                    avanceHtml = `<div class="avance-cell"><div class="avance-bar-container"></div><div class="avance-label">${avance}</div></div>`;
                                }

                                const fInicio = formatShortDate(r['F.INICIO']) || '';
                                const fFin    = formatShortDate(r['F.FIN']) || '';
                                const observ  = r.OBSERVACION || '';
                                const tarea = r.TAREA || '';

                                let hrs = r['HRS PROY.(AÑO)'];
                                if (hrs === null || hrs === undefined || hrs === '') {
                                        hrs = '';
                                } else {
                                        // Si es un número, formatearlo
                                        const hrsNum = parseFloat(String(hrs).replace(/[$,\s]/g, ''));
                                        if (!isNaN(hrsNum)) {
                                                hrs = formatNumber(hrsNum);
                                        }
                                }

                                html += `
                                    <tr>
                                        <td style="text-align: center;">${estadoIcon}</td>
                                        <td>${tarea}</td>
                                        <td style="text-align: center;">${avanceHtml}</td>
                                        <td style="text-align: center;">${fInicio}</td>
                                        <td style="text-align: center;">${fFin}</td>
                                        <td>${observ}</td>
                                        <td style="text-align: right;">${hrs}</td>
                                    </tr>
                                `;
                        });

                        html += `
                                </tbody>
                            </table>
                        </div>
                        `;
                });

        if (!html) {
            html = '<div style="text-align:center;padding:10px;">No hay datos para mostrar.</div>';
        }

        $informeModalBody.innerHTML = html;
        $informeModal.style.display = 'block';
    }

    function setupInformeModalListeners() {
        if ($informeButton) {
            $informeButton.addEventListener('click', openInformeModal);
        }
        if ($informeModalClose) {
            $informeModalClose.addEventListener('click', () => $informeModal.style.display = 'none');
        }
        if ($informeModal) {
            $informeModal.addEventListener('click', (e) => {
                if (e.target === $informeModal) $informeModal.style.display = 'none';
            });
        }

        // Toggle switch listener: re-render informe when changed and toggle modal background
        const $toggle = document.getElementById('informe-toggle-switch');
        if ($toggle) {
            $toggle.addEventListener('change', () => {
                if ($toggle.checked) $informeModal.classList.add('filter-active');
                else $informeModal.classList.remove('filter-active');

                // If modal is open, re-render report with new filter
                if ($informeModal.style.display === 'block') {
                    openInformeModal();
                }
            });
        }
    }

    function escapeHtml(value) {
        return String(value || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function parseNumericCell(value) {
        if (value === null || value === undefined || value === '') return 0;
        if (typeof value === 'number') return isNaN(value) ? 0 : value;

        const raw = String(value).trim();
        if (!raw) return 0;

        const hhmmMatch = raw.match(/^(-?\d+):(\d{1,2})$/);
        if (hhmmMatch) {
            const hh = parseInt(hhmmMatch[1], 10) || 0;
            const mm = parseInt(hhmmMatch[2], 10) || 0;
            return (hh * 60) + mm;
        }

        let normalized = raw.replace(/[^\d.,-]/g, '');
        if (!normalized) return 0;

        const hasDot = normalized.includes('.');
        const hasComma = normalized.includes(',');
        if (hasDot && hasComma) {
            normalized = normalized.replace(/,/g, '');
        } else if (!hasDot && hasComma) {
            normalized = normalized.replace(',', '.');
        }

        const num = parseFloat(normalized);
        return isNaN(num) ? 0 : num;
    }

    function getSafeHttpUrl(value) {
        const raw = String(value || '').trim();
        if (!raw) return '';

        let normalized = raw;
        if (/^www\./i.test(normalized) || /^drive\.google\.com\//i.test(normalized)) {
            normalized = `https://${normalized}`;
        }

        if (!/^https?:\/\//i.test(normalized)) return '';

        try {
            const parsed = new URL(normalized);
            if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') return '';
            return parsed.href;
        } catch (e) {
            return '';
        }
    }

    function normalizeACambioRows(rows) {
        return (rows || []).map(row => {
            const mes = row.MES || '';
            const area = row.AREA || '';
            const tipo = row.TIPO || row.TIPO_1 || row['TIPO PROYECTO'] || '';
            const agenteCambio = row['A.CAMBIO'] || row['A CAMBIO'] || row['A_CAMBIO'] || '';
            const proyecto = row.PROYECTO || '';
            const antes = row.ANTES || '';
            const frecuenciaAntes = row.FRECUENCIA || row.FRECUENCIA_1 || '';
            const ahora = row.AHORA || '';
            const frecuenciaAhora = row.FRECUENCIA_2 || row['FRECUENCIA AHORA'] || row['FRECUENCIA_ACTUAL'] || row.FRECUENCIA2 || '';
            const ahorroMin = parseNumericCell(row.AHORRO);
            const linkRaw = row.LINK || row.LINK_1 || row['LINK PROYECTO'] || '';
            const linkUrl = getSafeHttpUrl(linkRaw);
            return {
                mes,
                area,
                tipo,
                agenteCambio,
                proyecto,
                antes,
                frecuenciaAntes,
                ahora,
                frecuenciaAhora,
                ahorroMin,
                linkUrl
            };
        }).filter(r =>
            String(r.area).trim() ||
            String(r.tipo).trim() ||
            String(r.agenteCambio).trim() ||
            String(r.proyecto).trim() ||
            r.ahorroMin !== 0 ||
            String(r.linkUrl).trim()
        );
    }

    function aggregateACambio(rows, fieldName) {
        const map = new Map();
        rows.forEach(r => {
            const rawLabel = String(r[fieldName] || '').trim();
            const label = rawLabel || 'SIN DATO';
            if (!map.has(label)) map.set(label, { label, ahorroMin: 0, count: 0 });
            const curr = map.get(label);
            curr.ahorroMin += parseNumericCell(r.ahorroMin);
            curr.count += 1;
        });
        return Array.from(map.values())
            .sort((a, b) => (b.ahorroMin - a.ahorroMin) || (b.count - a.count) || a.label.localeCompare(b.label, 'es', { sensitivity: 'base' }));
    }

    function renderTopList(items) {
        if (!items || items.length === 0) {
            return '<div class="acambio-kpi-sub">Sin datos para mostrar.</div>';
        }
        return `
            <ul class="acambio-top-list">
                ${items.map(item => `
                    <li class="acambio-top-item">
                        <span class="acambio-top-label" title="${escapeHtml(item.label)}">${escapeHtml(item.label)}</span>
                        <span class="acambio-top-value">${formatNumber(item.ahorroMin)} min</span>
                    </li>
                `).join('')}
            </ul>
        `;
    }

    function openACambioModal() {
        if (!aCambioData || aCambioData.length === 0) {
            showError("No hay datos en la hoja 'A_cambio'.");
            return;
        }

        const rows = normalizeACambioRows(aCambioData);
        if (rows.length === 0) {
            showError("La hoja 'A_cambio' no tiene registros válidos.");
            return;
        }

        const totalRegistros = rows.length;
        const totalAhorroMin = rows.reduce((acc, r) => acc + parseNumericCell(r.ahorroMin), 0);
        const totalAhorroHoras = totalAhorroMin / 60;
        const totalAhorroDias = totalAhorroHoras / 9;

        const agentesUnicos = new Set(rows.map(r => String(r.agenteCambio || '').trim()).filter(Boolean)).size;
        const proyectosUnicos = new Set(rows.map(r => String(r.proyecto || '').trim()).filter(Boolean)).size;
        const ahorroPromedioProyectoHoras = proyectosUnicos > 0 ? (totalAhorroHoras / proyectosUnicos) : 0;
        const ahorroPromedioRegistroMin = totalRegistros > 0 ? (totalAhorroMin / totalRegistros) : 0;

        const topAreas = aggregateACambio(rows, 'area').slice(0, 7);
        const topTipos = aggregateACambio(rows, 'tipo').slice(0, 7);
        const topAgentes = aggregateACambio(rows, 'agenteCambio').slice(0, 7);
        const topMeses = aggregateACambio(rows, 'mes').slice(0, 7);

        const rowsSorted = rows.slice().sort((a, b) => (b.ahorroMin - a.ahorroMin));

        const html = `
            <div class="acambio-kpis">
                <div class="acambio-kpi-card">
                    <div class="acambio-kpi-title">Registros A.cambio</div>
                    <div class="acambio-kpi-value">${formatNumber(totalRegistros)}</div>
                    <div class="acambio-kpi-sub">Filas procesadas</div>
                </div>
                <div class="acambio-kpi-card">
                    <div class="acambio-kpi-title">Agentes de Cambio</div>
                    <div class="acambio-kpi-value">${formatNumber(agentesUnicos)}</div>
                    <div class="acambio-kpi-sub">Responsables activos</div>
                </div>
                <div class="acambio-kpi-card">
                    <div class="acambio-kpi-title">Proyectos</div>
                    <div class="acambio-kpi-value">${formatNumber(proyectosUnicos)}</div>
                    <div class="acambio-kpi-sub">Proyectos con ahorro</div>
                </div>
                <div class="acambio-kpi-card">
                    <div class="acambio-kpi-title">Ahorro Total</div>
                    <div class="acambio-kpi-value">${formatNumber(totalAhorroMin)} min</div>
                    <div class="acambio-kpi-sub">${formatNumberOneDecimal(totalAhorroHoras)} h | ${formatNumberOneDecimal(totalAhorroDias)} dias (9 h/dia)</div>
                </div>
                <div class="acambio-kpi-card">
                    <div class="acambio-kpi-title">Promedio por Proyecto</div>
                    <div class="acambio-kpi-value">${formatNumberOneDecimal(ahorroPromedioProyectoHoras)} h</div>
                    <div class="acambio-kpi-sub">${formatNumberOneDecimal(ahorroPromedioRegistroMin)} min por registro</div>
                </div>
            </div>

            <div class="acambio-top-grid">
                <div class="acambio-top-card">
                    <div class="acambio-top-title">Top Areas por Ahorro</div>
                    ${renderTopList(topAreas)}
                </div>
                <div class="acambio-top-card">
                    <div class="acambio-top-title">Top Tipos por Ahorro</div>
                    ${renderTopList(topTipos)}
                </div>
                <div class="acambio-top-card">
                    <div class="acambio-top-title">Top Agentes de Cambio</div>
                    ${renderTopList(topAgentes)}
                </div>
                <div class="acambio-top-card">
                    <div class="acambio-top-title">Top Meses</div>
                    ${renderTopList(topMeses)}
                </div>
            </div>

            <table class="modal-table">
                <thead>
                    <tr>
                        <th style="width: 7%;">MES</th>
                        <th style="width: 8%;">AREA</th>
                        <th style="width: 8%;">TIPO</th>
                        <th style="width: 10%;">A.CAMBIO</th>
                        <th style="width: 14%;">PROYECTO</th>
                        <th style="width: 10%;">ANTES</th>
                        <th style="width: 8%;">FRECUENCIA</th>
                        <th style="width: 10%;">AHORA</th>
                        <th style="width: 8%;">FRECUENCIA</th>
                        <th style="width: 9%;">AHORRO</th>
                        <th style="width: 8%;">DETALLE</th>
                    </tr>
                </thead>
                <tbody>
                    ${rowsSorted.map(r => {
                        const h = r.ahorroMin / 60;
                        const d = h / 9;
                        const detailHtml = r.linkUrl
                            ? `<a class="acambio-link-btn" href="${escapeHtml(r.linkUrl)}" target="_blank" rel="noopener noreferrer" title="Abrir carpeta de Drive">&#128269; Ver detalle</a>`
                            : '<span style="color:#94a3b8;">-</span>';
                        return `
                            <tr>
                                <td>${escapeHtml(r.mes)}</td>
                                <td>${escapeHtml(r.area)}</td>
                                <td>${escapeHtml(r.tipo)}</td>
                                <td>${escapeHtml(r.agenteCambio)}</td>
                                <td>${escapeHtml(r.proyecto)}</td>
                                <td>${escapeHtml(r.antes)}</td>
                                <td>${escapeHtml(r.frecuenciaAntes)}</td>
                                <td>${escapeHtml(r.ahora)}</td>
                                <td>${escapeHtml(r.frecuenciaAhora)}</td>
                                <td>${formatNumber(r.ahorroMin)} min<br><span style="color:#475569;font-size:11px;">${formatNumberOneDecimal(h)} h | ${formatNumberOneDecimal(d)} d</span></td>
                                <td style="text-align:center;">${detailHtml}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;

        $acambioModalBody.innerHTML = html;
        $acambioModal.style.display = 'block';
    }

    function setupACambioModalListeners() {
        if ($acambioButton) {
            $acambioButton.addEventListener('click', openACambioModal);
        }
        if ($acambioModalClose) {
            $acambioModalClose.addEventListener('click', () => $acambioModal.style.display = 'none');
        }
        if ($acambioModal) {
            $acambioModal.addEventListener('click', (e) => {
                if (e.target === $acambioModal) $acambioModal.style.display = 'none';
            });
        }
    }

    // === KANBAN ===
    function displayKanbanModal() {
        if (!kanbanData || kanbanData.length === 0) {
            showError("No se encontraron datos en la hoja 'Kanban' o aún no se han cargado.");
            return;
        }

        $kanbanColEstacionamiento.innerHTML = '<h3>Estacionamiento</h3>';
        $kanbanColEnProceso.innerHTML = '<h3>En proceso</h3>';
        $kanbanColTerminado.innerHTML = '<h3>Terminado</h3>';

        let colorIndex = 1;

        kanbanData.forEach(row => {
            const estadoLower = (row.ESTADO || '').toLowerCase();
            let targetColumn;

            if (estadoLower === 'estacionamiento') targetColumn = $kanbanColEstacionamiento;
            else if (estadoLower === 'en proceso') targetColumn = $kanbanColEnProceso;
            else if (estadoLower === 'terminado') targetColumn = $kanbanColTerminado;
            else return;

            const card = document.createElement('div');
            card.className = `kanban-card color-${colorIndex}`;

            card.innerHTML = `
                <div class="card-title">${row.TAREA || 'Sin Tarea'}</div>
                <div class="card-detail">Area: ${row.AREA || 'N/A'}</div>
                <div class="card-detail">Responsable: ${row.RESPONSABLE || 'N/A'}</div>
            `;

            targetColumn.appendChild(card);
            colorIndex = (colorIndex % 5) + 1;
        });

        $kanbanModal.style.display = 'block';
    }

    function setupKanbanModalListeners() {
        $kanbanButton.addEventListener('click', displayKanbanModal);
        $kanbanModalClose.addEventListener('click', () => $kanbanModal.style.display = 'none');
        $kanbanModal.addEventListener('click', (e) => {
            if (e.target === $kanbanModal) $kanbanModal.style.display = 'none';
        });
    }

    // --- FLUJO PRINCIPAL ---
    showLoading();
    loadSheetJSONP(SHEET_ID, SHEET_NAME_BD)
        .then(rowsBd => {
            if (!Array.isArray(rowsBd)) throw new Error(`La hoja "${SHEET_NAME_BD}" no devolvió datos válidos.`);
            allRowsData = rowsBd;
            updateMapWithData(allRowsData);
            setupDetailsModalListeners();
            return Promise.all([
                loadSheetJSONP(SHEET_ID, SHEET_NAME_KANBAN).catch(() => []),
                loadSheetJSONP(SHEET_ID, SHEET_NAME_ACAMBIO).catch(() => [])
            ]);
        })
        .then(([rowsKanban, rowsACambio]) => {
            if (!Array.isArray(rowsKanban)) {
                kanbanData = [];
            } else {
                kanbanData = rowsKanban;
            }
            if (!Array.isArray(rowsACambio)) {
                aCambioData = [];
            } else {
                aCambioData = rowsACambio;
            }
            setupKanbanModalListeners();
            setupACambioModalListeners();
            hideLoading();
            alignColumnHeights();
        })
        .catch(err => {
            hideLoading();
            alignColumnHeights();
            console.error('[GViz JSONP Error]', err);
            showError(err.message || 'No se pudo leer una de las Google Sheets.');
        });

    window.addEventListener('resize', alignColumnHeights);
});
</script>

<!-- Embebido: vista Gantt (ahora modal) -->
<div id="gantt-modal" style="display:none;">
    <div class="kanban-content" style="max-width:1200px;width:95%;padding:20px;background:#ffffff;position:relative;max-height:86vh;overflow:auto;border-radius:10px;">
        <span class="modal-close" id="gantt-close">&times;</span>
    <div class="mb-6 flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">Panel de Control Maestro (Gantt)</h1>
            <p class="text-slate-500">Gestión por Áreas y Cronograma Q1</p>
        </div>
        <div class="space-x-2">
            <button id="gantt-back" class="bg-white border border-slate-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-50">Volver</button>
            <button id="gantt-open-window" class="bg-white border border-slate-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-50">Abrir en ventana</button>
            <button id="gantt-fit" class="bg-white border border-slate-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-50">Ajustar ancho</button>
            <button onclick="toggleAll(true)" class="bg-white border border-slate-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-50">Expandir</button>
            <button onclick="toggleAll(false)" class="bg-white border border-slate-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-50">Contraer</button>
        </div>
    </div>

    <div class="gantt-viewport overflow-x-auto shadow-xl rounded-xl border border-slate-200">
        <div class="gantt-grid" id="mainGrid">
            <!-- FILA 1: CABECERAS DE MESES -->
            <div class="header-cell sticky-1"></div>
            <div class="header-cell sticky-2">DATOS</div>
            <div class="header-cell">GENERALES</div>
            <div class="header-cell">DEL</div>
            <div class="header-cell">PROYECTO</div>
            <div class="header-cell">TAREA</div>
            <div class="header-cell"> </div>
            <div class="header-cell bg-blue-900" style="grid-column: span 4;">ENERO</div>
            <div class="header-cell bg-indigo-900" style="grid-column: span 4;">FEBRERO</div>
            <div class="header-cell bg-slate-800" style="grid-column: span 5;">MARZO</div>

            <!-- FILA 2: TITULOS DE COLUMNAS REQUERIDOS -->
            <div class="header-cell sticky-1 bg-slate-100 !text-slate-800"></div>
            <div class="header-cell sticky-2 bg-slate-100 !text-slate-800">AREA</div>
            <div class="header-cell bg-slate-100 !text-slate-800">TIPO</div>
            <div class="header-cell bg-slate-100 !text-slate-800">F. INICIO</div>
            <div class="header-cell bg-slate-100 !text-slate-800">PROYECTO</div>
            <div class="header-cell bg-slate-100 !text-slate-800">TAREA</div>
            <div class="header-cell bg-slate-100 !text-slate-800">EJECUTOR</div>
            <div class="header-cell bg-slate-100 !text-slate-800">ESTADO</div>
            <!-- Semanas S01 a S13 -->
            <script>
                for(let i=1; i<=13; i++) {
                    document.write(`<div class="header-cell bg-slate-50 !text-slate-500 !font-medium border-slate-200">S${i.toString().padStart(2, '0')}</div>`);
                }
            </script>

            <!-- CONTENIDO DINÁMICO -->
        </div>
    </div>

    <script>
        // Gantt embedded script (based on gantt.html) - adjusted to expose render as window.ganttRender
        const projectData = [
            {
                id: "p1",
                area: "HILANDERIA",
                tipo: "PROYECTO",
                inicio: "14/01",
                nombre: "Digitalización y sistematización de planta",
                ejecutor: "EO",
                expanded: true,
                tasks: [
                    { tipo: "Proceso", inicio: "14/01", nombre: "Revisión y análisis de situación actual", ejecutor: "EO", gantt: [1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] },
                    { tipo: "Digital", inicio: "21/01", nombre: "App capacidades de producción", ejecutor: "EO", gantt: [0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0] },
                    { tipo: "Digital", inicio: "04/02", nombre: "Gantt de producción por máquinas", ejecutor: "EO", gantt: [0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0] },
                    { tipo: "Digital", inicio: "18/02", nombre: "Sistematización de Hoja de Ruta", ejecutor: "EO", gantt: [0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0] },
                    { tipo: "Digital", inicio: "25/02", nombre: "Control de piso (Continuas)", ejecutor: "EO", gantt: [0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0] }
                ]
            }
        ];

        let isPainting = false;
        let paintValue = true;
        let lastPaintedProject = null;

        window.addEventListener('mouseup', () => {
            if(isPainting) {
                isPainting = false;
                if(lastPaintedProject) {
                            // restore user-select and refresh master visually
                            document.body.style.userSelect = '';
                            refreshMasterForProject(lastPaintedProject);
                    lastPaintedProject = null;
                }
            }
        });

        function createWeekCellDirect(cell, isOn, pId, taskIndex, weekIndex) {
            // Populate a pre-created div element with week cell content
            cell.className = 'data-cell task-row-bg week-cell';
            cell.dataset.projectId = pId;
            cell.dataset.taskIndex = taskIndex;
            cell.dataset.weekIndex = weekIndex;
            // stable indicator element (no text) to toggle painted state without changing layout
            const indicator = document.createElement('div');
            indicator.className = 'gantt-block-indicator';
            if(isOn) { indicator.classList.add('on'); cell.classList.add('on'); }
            cell.appendChild(indicator);

            cell.addEventListener('mousedown', (e) => {
                e.preventDefault();
                // prevent text selection while painting
                document.body.style.userSelect = 'none';
                const p = projectData.find(x => x.id === pId);
                const current = !!p.tasks[taskIndex].gantt[weekIndex];
                paintValue = !current;
                p.tasks[taskIndex].gantt[weekIndex] = paintValue ? 1 : 0;
                isPainting = true;
                lastPaintedProject = pId;
                if(paintValue) { indicator.classList.add('on'); cell.classList.add('on'); } else { indicator.classList.remove('on'); cell.classList.remove('on'); }
            });

            cell.addEventListener('mouseenter', () => {
                if(!isPainting) return;
                const p = projectData.find(x => x.id === pId);
                p.tasks[taskIndex].gantt[weekIndex] = paintValue ? 1 : 0;
                lastPaintedProject = pId;
                if(paintValue) { indicator.classList.add('on'); cell.classList.add('on'); } else { indicator.classList.remove('on'); cell.classList.remove('on'); }
            });
        }

        function updateStatusSelectClass(select, value) {
            select.classList.remove('status-en-proceso','status-terminado','status-pendiente');
            const v = (value || '').toString().toUpperCase();
            if(v === 'EN PROCESO') select.classList.add('status-en-proceso');
            else if(v === 'TERMINADO') select.classList.add('status-terminado');
            else select.classList.add('status-pendiente');
        }

        function getProjectSpan(p) {
            let min = 13, max = -1;
            p.tasks.forEach(t => {
                let first = -1, last = -1;
                for(let i=0;i<t.gantt.length;i++) if(t.gantt[i] === 1) { first = i; break; }
                for(let i=t.gantt.length-1;i>=0;i--) if(t.gantt[i] === 1) { last = i; break; }
                if(first !== -1 && first < min) min = first;
                if(last !== -1 && last > max) max = last;
            });
            if(min === 13 || max === -1) return null;
            return { start: min, end: max };
        }

        function render() {
            const grid = document.getElementById('mainGrid');
            const cols = 21; // 8 fixed cols + 13 weeks
            const headersCount = cols * 2;
            while (grid.children.length > headersCount) {
                grid.removeChild(grid.lastChild);
            }

            projectData.forEach((p, pIdx) => {
                const span = getProjectSpan(p);

                const arrowDiv = createCell(grid, p.expanded ? '▼' : '▶', `sticky-1 project-row-bg cursor-pointer justify-center`, () => toggle(p.id));
                arrowDiv.dataset.projectId = p.id;
                createCell(grid, p.area, `sticky-2 project-row-bg text-blue-700 font-bold`, () => toggle(p.id));
                createCell(grid, p.tipo, `project-row-bg text-slate-400 font-medium`, () => toggle(p.id));
                createCell(grid, p.inicio, `project-row-bg justify-center font-bold`, () => toggle(p.id));
                const proyectoLabel = p.nombre;
                createCell(grid, proyectoLabel, `project-row-bg truncate-text`, () => toggle(p.id));
                const tareaDiv = document.createElement('div');
                tareaDiv.className = 'data-cell project-row-bg';
                const select = document.createElement('select');
                select.className = 'w-full bg-transparent text-slate-800';
                p.tasks.forEach((t, i) => {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.text = t.nombre;
                    select.appendChild(opt);
                });
                tareaDiv.appendChild(select);
                tareaDiv.onclick = () => toggle(p.id);
                grid.appendChild(tareaDiv);

                // project status cell (before weeks)
                createCell(grid, p.ejecutor, `project-row-bg justify-center font-bold`, () => toggle(p.id));
                const statusCell = createCell(grid, '', `project-row-bg justify-center`, () => toggle(p.id));
                const projStatus = p.status || 'PENDIENTE';
                const projSelect = document.createElement('select');
                projSelect.className = 'status-select';
                ['PENDIENTE','EN PROCESO','TERMINADO'].forEach(sv => {
                    const o = document.createElement('option'); o.value = sv; o.text = sv; if(sv === projStatus) o.selected = true; projSelect.appendChild(o);
                });
                updateStatusSelectClass(projSelect, projStatus);
                projSelect.addEventListener('change', (e) => { p.status = e.target.value; updateStatusSelectClass(projSelect, e.target.value); refreshMasterForProject(p.id); });
                statusCell.appendChild(projSelect);

                // compute project completion % based on tasks status
                const totalTasks = p.tasks.length || 0;
                const completedTasks = p.tasks.filter(t => (t.status || '').toString().toUpperCase() === 'TERMINADO').length;
                const percent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

                for(let i=0; i<13; i++) {
                    const cell = createCell(grid, '', `project-row-bg`);
                    // create stable master container inside the cell to avoid reflows when toggling
                    const mc = document.createElement('div');
                    mc.className = 'gantt-master-container';
                    const inner = document.createElement('div');
                    inner.className = 'gantt-master-inner';
                    const label = document.createElement('div');
                    label.className = 'gantt-master-label';
                    // show percent on the first week cell, keep project name as tooltip
                    label.textContent = `${percent}%`;
                    label.title = p.nombre;
                    inner.appendChild(label);
                    mc.appendChild(inner);
                    cell.appendChild(mc);
                    // Render master bar fully across weeks (complete bar for project)
                    inner.classList.add('on');
                    // show label only on first week
                    if(i === 0) label.classList.remove('hidden'); else label.classList.add('hidden');
                }

                // Always render task rows (will toggle visibility by hiding their cells)
                p.tasks.forEach((t, tIdx) => {
                    for(let cellIdx = 0; cellIdx < 21; cellIdx++) {
                        const cell = document.createElement('div');
                        // annotate for toggling
                        cell.dataset.projectId = p.id;
                        cell.dataset.taskIndex = tIdx;
                        if(cellIdx === 0) { cell.className = 'data-cell sticky-1 task-row-bg'; }
                        else if(cellIdx === 1) { cell.className = 'data-cell sticky-2 task-row-bg text-slate-400 text-xs'; cell.textContent = p.area; }
                        else if(cellIdx === 2) { cell.className = 'data-cell task-row-bg text-slate-500 font-medium'; cell.textContent = t.tipo; }
                        else if(cellIdx === 3) { cell.className = 'data-cell task-row-bg justify-center text-slate-500'; cell.textContent = t.inicio; }
                        else if(cellIdx === 4) { cell.className = 'data-cell task-row-bg pl-2 text-slate-500 text-sm'; cell.textContent = p.nombre; }
                        else if(cellIdx === 5) { cell.className = 'data-cell task-row-bg pl-6 text-blue-600 font-medium italic'; cell.textContent = t.nombre; }
                        else if(cellIdx === 6) { cell.className = 'data-cell task-row-bg justify-center'; cell.textContent = t.ejecutor; }
                        else if(cellIdx === 7) {
                            // status select per task
                            cell.className = 'data-cell task-row-bg justify-center';
                            const taskStatus = t.status || 'PENDIENTE';
                            const sel = document.createElement('select');
                            sel.className = 'status-select';
                            ['PENDIENTE','EN PROCESO','TERMINADO'].forEach(sv => { const o = document.createElement('option'); o.value = sv; o.text = sv; if(sv===taskStatus) o.selected = true; sel.appendChild(o); });
                            updateStatusSelectClass(sel, taskStatus);
                            sel.addEventListener('change', (e) => { t.status = e.target.value; updateStatusSelectClass(sel, e.target.value); refreshMasterForProject(p.id); });
                            cell.appendChild(sel);
                        } else {
                            // Week cells (indices 8-20)
                            const weekIdx = cellIdx - 8;
                            createWeekCellDirect(cell, !!t.gantt[weekIdx], p.id, tIdx, weekIdx);
                        }
                        // hide task cells if collapsed
                        if(!p.expanded) cell.style.display = 'none';
                        grid.appendChild(cell);
                    }
                });
            });
        }

        function createCell(parent, content, className, clickFn) {
            const div = document.createElement('div');
            div.className = `data-cell ${className}`;
            div.innerHTML = content;
            if(clickFn) div.onclick = clickFn;
            parent.appendChild(div);
            return div;
        }

        function refreshMasterForProject(pId) {
            const grid = document.getElementById('mainGrid');
            const cols = 21;
            let idx = -1;
            for(let i=0;i<grid.children.length;i++){
                const ch = grid.children[i];
                if(ch.dataset && ch.dataset.projectId === pId) { idx = i; break; }
            }
            if(idx === -1) return;
            const rowStart = Math.floor(idx / cols) * cols;
            const p = projectData.find(x => x.id === pId);
            // recompute percent and update master bar (we render full bar across weeks)
            const totalTasks = p.tasks.length || 0;
            const completedTasks = p.tasks.filter(t => (t.status || '').toString().toUpperCase() === 'TERMINADO').length;
            const percent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            for(let w=0; w<13; w++) {
                const cell = grid.children[rowStart + 8 + w];
                if(!cell) continue;
                const inner = cell.querySelector('.gantt-master-inner');
                const label = cell.querySelector('.gantt-master-label');
                if(!inner) continue;
                // ensure master bar is shown
                inner.classList.add('on');
                inner.classList.remove('start','end');
                if(label) {
                    label.textContent = `${percent}%`;
                    label.title = p.nombre || '';
                    if(w === 0) label.classList.remove('hidden'); else label.classList.add('hidden');
                }
            }
        }

        function toggle(id) {
            const p = projectData.find(x => x.id === id);
            p.expanded = !p.expanded;
            const grid = document.getElementById('mainGrid');
            // Update arrow in master row
            for(let i=0; i<grid.children.length; i++) {
                const ch = grid.children[i];
                if(ch.dataset && ch.dataset.projectId === id && ch.classList.contains('sticky-1')) {
                    ch.textContent = p.expanded ? '▼' : '▶';
                    break;
                }
            }
            // Toggle visibility of all task cells for this project
            const taskCells = grid.querySelectorAll(`[data-project-id="${id}"][data-task-index]`);
            taskCells.forEach(cell => {
                cell.style.display = p.expanded ? '' : 'none';
            });
        }
        function toggleAll(val) {
            projectData.forEach(p => p.expanded = val);
            const grid = document.getElementById('mainGrid');
            // Update all master row arrows
            projectData.forEach(p => {
                for(let i=0; i<grid.children.length; i++) {
                    const ch = grid.children[i];
                    if(ch.dataset && ch.dataset.projectId === p.id && ch.classList.contains('sticky-1')) {
                        ch.textContent = p.expanded ? '▼' : '▶';
                        break;
                    }
                }
                // Toggle visibility of all task cells for this project
                const taskCells = grid.querySelectorAll(`[data-project-id="${p.id}"][data-task-index]`);
                taskCells.forEach(cell => {
                    cell.style.display = p.expanded ? '' : 'none';
                });
            });
        }

        // Fit-to-width control
        let ganttFitEnabled = true;
        function fitGanttToWidth() {
            const viewport = document.querySelector('#gantt-modal .gantt-viewport');
            const grid = document.querySelector('#gantt-modal .gantt-grid');
            if(!viewport || !grid) return;
            // reset transform to measure
            grid.style.transform = 'none';
            const vw = viewport.clientWidth;
            const gw = grid.scrollWidth;
            let scale = 1;
            if (gw > 0) scale = Math.min(1, vw / gw);
            grid.style.transform = `scale(${scale})`;
            // adjust viewport height to scaled grid height so scroll behaves
            const gridHeight = grid.getBoundingClientRect().height;
            viewport.style.height = (gridHeight * scale) + 'px';
        }

        // Exponer la función render para llamarla desde la página principal
        window.ganttRender = function(){ render(); if (ganttFitEnabled) fitGanttToWidth(); };

        // Toggle fit button
        document.addEventListener('click', (e) => {
            if(e.target && e.target.id === 'gantt-fit'){
                ganttFitEnabled = !ganttFitEnabled;
                if(ganttFitEnabled) fitGanttToWidth(); else {
                    const grid = document.querySelector('#gantt-modal .gantt-grid');
                    const viewport = document.querySelector('#gantt-modal .gantt-viewport');
                    if(grid) grid.style.transform = 'none';
                    if(viewport) viewport.style.height = 'auto';
                }
            }
        });

        window.addEventListener('resize', () => {
            const gv = document.getElementById('gantt-modal');
            if(gv && gv.style.display !== 'none' && ganttFitEnabled) fitGanttToWidth();
        });

        // Back button handler
        const closeGantt = () => {
            const main = document.querySelector('.main-layout-container');
            const ganttModal = document.getElementById('gantt-modal');
            if (ganttModal) ganttModal.style.display = 'none';
            if (main) main.style.display = '';
        };
        document.getElementById('gantt-back').addEventListener('click', closeGantt);
        const gc = document.getElementById('gantt-close');
        if(gc) gc.addEventListener('click', closeGantt);
        // Open Gantt in a new window (static snapshot of rendered grid)
        const openBtn = document.getElementById('gantt-open-window');
        if(openBtn) openBtn.addEventListener('click', () => {
            try {
                const headStyles = Array.from(document.querySelectorAll('head style')).map(s => s.outerHTML).join('\n');
                const headLinks = '<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">\n<script src="https://cdn.tailwindcss.com"></' + 'script>';
                const grid = document.getElementById('mainGrid');
                if(!grid) return alert('Gantt no renderizado aún. Abre el Gantt primero.');
                const gridHtml = grid.outerHTML;
                const html = `<!doctype html><html><head><meta charset="utf-8">${headLinks}${headStyles}<title>Gantt - Ventana</title></head><body style="margin:0;padding:18px;background:#f3f4f6;">${gridHtml}</body></html>`;
                const w = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes');
                w.document.open();
                w.document.write(html);
                w.document.close();
            } catch (e) { alert('No se pudo abrir la ventana: '+e.message); }
        });
        // Close when clicking outside the content
        const ganttOverlay = document.getElementById('gantt-modal');
        if(ganttOverlay) {
            ganttOverlay.addEventListener('click', (e) => { if(e.target === ganttOverlay) closeGantt(); });
        }
    </script>
    </div>
</div>

</body>
</html>
